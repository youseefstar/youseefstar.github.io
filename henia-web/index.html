<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù‡Ù†ÛŒØ§</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    user-select: none;
    transition: background 0.5s ease;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ */
  .main-menu {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.7);
    z-index: 100;
    backdrop-filter: blur(5px);
    transition: opacity 0.5s ease, transform 0.5s ease;
    padding: 20px;
    transform: translateY(0);
  }

  .main-menu.hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateY(-100%);
  }

  .game-title {
    color: white;
    font-size: clamp(32px, 10vw, 60px);
    margin-bottom: 15px;
    text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    text-align: center;
  }
  
  .high-score {
    color: #ffcc00;
    font-size: clamp(18px, 5vw, 28px);
    margin-bottom: 10px;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    text-align: center;
  }
  
  .player-level {
    color: #00ffcc;
    font-size: clamp(16px, 4vw, 24px);
    margin-bottom: 30px;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    text-align: center;
  }

  .menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 20px;
    width: min(300px, 80%);
  }

  .menu-btn {
    background: linear-gradient(135deg, #ff416c, #ff4b2b);
    border: none;
    color: white;
    padding: 15px 30px;
    border-radius: 30px;
    cursor: pointer;
    font-size: clamp(16px, 5vw, 20px);
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  }

  .menu-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(255, 75, 43, 0.5);
  }

  .theme-btn {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
  }
  
  .download-btn {
    background: linear-gradient(135deg, #00b09b, #96c93d);
  }

  .game-modes-btn {
    background: linear-gradient(135deg, #ff8c00, #ff4500);
  }

  .customization-btn {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ… */
  .theme-selection {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    z-index: 200;
    backdrop-filter: blur(5px);
    padding: 20px;
    overflow-y: auto;
    transition: opacity 0.5s ease, transform 0.5s ease;
    transform: translateX(100%);
  }

  .theme-selection.active {
    display: flex;
    transform: translateX(0);
  }

  .theme-title {
    color: white;
    font-size: clamp(24px, 7vw, 36px);
    margin-bottom: 30px;
    text-align: center;
  }

  .theme-options {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 800px;
    width: 100%;
  }

  .theme-option {
    width: min(150px, 40vw);
    height: min(120px, 30vw);
    border-radius: 15px;
    cursor: pointer;
    overflow: hidden;
    position: relative;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }
  
  .theme-option.locked {
    cursor: not-allowed;
    opacity: 0.6;
    filter: grayscale(0.7);
  }

  .theme-option:hover:not(.locked) {
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
  }

  .theme-option.default {
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
  }

  .theme-name {
    position: absolute;
    bottom: 10px;
    left: 0;
    width: 100%;
    text-align: center;
    color: white;
    font-weight: bold;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    font-size: clamp(12px, 3vw, 16px);
  }
  
  .lock-icon {
    position: absolute;
    top: 5px;
    right: 5px;
    color: gold;
    font-size: 20px;
  }
  
  .level-requirement {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
  }

  .back-btn {
    margin-top: 30px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
  }

  .back-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ */
  .game-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  canvas {
    background: linear-gradient(160deg, #222831, #393e46);
    display: none;
    transition: filter 0.5s ease;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .blur-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(5px);
    background: rgba(0, 0, 0, 0.3);
    z-index: 5;
    display: none;
  }

  .score-container {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.5);
    padding: 8px 16px;
    border-radius: 30px;
    color: white;
    font-weight: bold;
    font-size: clamp(14px, 4vw, 20px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: none;
    z-index: 6;
  }
  
  .level-container {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.5);
    padding: 8px 16px;
    border-radius: 30px;
    color: white;
    font-weight: bold;
    font-size: clamp(14px, 4vw, 20px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: none;
    z-index: 6;
  }

  .time-container {
    position: absolute;
    top: 70px;
    right: 20px;
    background: rgba(0, 0, 0, 0.5);
    padding: 8px 16px;
    border-radius: 30px;
    color: #00ffcc;
    font-weight: bold;
    font-size: clamp(14px, 4vw, 20px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: none;
    z-index: 6;
  }
  
  .title {
    position: absolute;
    top: 20px;
    color: white;
    font-size: clamp(18px, 6vw, 28px);
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    text-align: center;
    width: 100%;
    display: none;
    z-index: 6;
  }

  .instructions {
    position: absolute;
    bottom: 20px;
    color: rgba(255, 255, 255, 0.7);
    font-size: clamp(12px, 3vw, 16px);
    text-align: center;
    width: 100%;
    display: none;
    z-index: 6;
    padding: 0 10px;
  }

  .game-over {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    text-align: center;
    font-size: clamp(18px, 6vw, 28px);
    z-index: 10;
    padding: 20px;
    transition: opacity 0.5s ease, transform 0.5s ease;
    transform: scale(0.8);
    opacity: 0;
  }
  
  .game-over.active {
    display: flex;
    transform: scale(1);
    opacity: 1;
  }
  
  .level-up {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    text-align: center;
    font-size: clamp(18px, 6vw, 28px);
    z-index: 15;
    padding: 20px;
    animation: levelUpAnimation 1.5s ease;
  }
  
  @keyframes levelUpAnimation {
    0% { opacity: 0; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }

  .restart-btn, .menu-back-btn {
    background: linear-gradient(135deg, #ff416c, #ff4b2b);
    border: none;
    color: white;
    padding: 10px 20px;
    margin-top: 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: clamp(14px, 4vw, 18px);
    transition: all 0.3s ease;
    margin-right: 10px;
  }

  .menu-back-btn {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
  }

  .restart-btn:hover, .menu-back-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4);
  }

  .button-group {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ */
  .game-modes-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    z-index: 200;
    backdrop-filter: blur(5px);
    padding: 20px;
    overflow-y: auto;
    transition: opacity 0.5s ease, transform 0.5s ease;
    transform: translateX(100%);
    color: white;
    text-align: center;
  }
  
  .game-modes-page.active {
    display: flex;
    transform: translateX(0);
  }
  
  .game-modes-title {
    font-size: clamp(24px, 7vw, 36px);
    margin-bottom: 30px;
  }
  
  .game-modes-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    max-width: 800px;
    width: 100%;
    margin-bottom: 20px;
  }
  
  .game-mode {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }
  
  .game-mode:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }
  
  .game-mode.active {
    background: rgba(255, 255, 255, 0.3);
    border: 2px solid #ffcc00;
  }
  
  .mode-icon {
    font-size: 40px;
    margin-bottom: 10px;
  }
  
  .mode-description {
    font-size: 14px;
    opacity: 0.8;
    margin-top: 10px;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ */
  .customization-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    z-index: 200;
    backdrop-filter: blur(5px);
    padding: 20px;
    overflow-y: auto;
    transition: opacity 0.5s ease, transform 0.5s ease;
    transform: translateX(100%);
    color: white;
    text-align: center;
  }
  
  .customization-page.active {
    display: flex;
    transform: translateX(0);
  }
  
  .customization-title {
    font-size: clamp(24px, 7vw, 36px);
    margin-bottom: 30px;
  }
  
  .customization-options {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    max-width: 800px;
    width: 100%;
    margin-bottom: 20px;
  }
  
  .customization-option {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }
  
  .customization-option:hover:not(.locked) {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }
  
  .customization-option.locked {
    cursor: not-allowed;
    opacity: 0.6;
    filter: grayscale(0.7);
  }
  
  .customization-option.active {
    background: rgba(255, 255, 255, 0.3);
    border: 2px solid #ffcc00;
  }
  
  .option-icon {
    font-size: 40px;
    margin-bottom: 10px;
  }
  
  .option-description {
    font-size: 14px;
    opacity: 0.8;
    margin-top: 10px;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Ø²ÛŒ */
  .tutorial {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 20px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
    z-index: 25;
    display: none;
    text-align: center;
    backdrop-filter: blur(5px);
  }
  
  .tutorial.active {
    display: block;
  }
  
  .tutorial h3 {
    margin-bottom: 15px;
    color: #ffcc00;
  }
  
  .tutorial p {
    margin-bottom: 10px;
    line-height: 1.5;
  }
  
  .close-tutorial {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    margin-top: 15px;
    transition: all 0.3s ease;
  }
  
  .close-tutorial:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú© */
  @media (max-width: 480px) and (max-height: 700px) {
    .menu-buttons {
      gap: 15px;
    }
    
    .menu-btn {
      padding: 12px 24px;
    }
    
    .theme-options {
      gap: 10px;
    }
    
    .theme-option {
      width: min(130px, 42vw);
      height: min(100px, 32vw);
    }
    
    .button-group {
      flex-direction: column;
      align-items: center;
    }
    
    .restart-btn, .menu-back-btn {
      margin-right: 0;
      width: 200px;
    }

    .game-modes-container, .customization-options {
      grid-template-columns: 1fr;
    }
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª landscape Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
  @media (max-height: 500px) {
    .main-menu {
      padding: 10px;
    }
    
    .game-title {
      margin-bottom: 10px;
    }
    
    .high-score {
      margin-bottom: 10px;
    }
    
    .player-level {
      margin-bottom: 20px;
    }
    
    .menu-buttons {
      gap: 15px;
    }
    
    .theme-selection {
      padding: 10px;
    }
    
    .theme-title {
      margin-bottom: 20px;
    }
    
    .theme-options {
      gap: 10px;
    }
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ÛŒÛŒ */
  @media (max-width: 768px) {
    .game-container {
      max-width: 100%;
      max-height: 100%;
    }

    .score-container, .level-container, .time-container {
      padding: 6px 12px;
      font-size: clamp(12px, 3.5vw, 16px);
    }
    
    .score-container {
      top: 10px;
      left: 10px;
    }
    
    .level-container {
      top: 10px;
      right: 10px;
    }
    
    .time-container {
      top: 50px;
      right: 10px;
    }
  }

  @media (orientation: landscape) and (max-height: 500px) {
    .game-title {
      font-size: clamp(24px, 8vw, 40px);
      margin-bottom: 5px;
    }
    
    .high-score, .player-level {
      font-size: clamp(14px, 4vw, 20px);
      margin-bottom: 5px;
    }
    
    .menu-buttons {
      gap: 10px;
    }
    
    .menu-btn {
      padding: 8px 16px;
      font-size: clamp(14px, 4vw, 18px);
    }
    
    .theme-options {
      gap: 8px;
    }
    
    .theme-option {
      width: min(120px, 28vw);
      height: min(90px, 20vw);
    }
  }

  /* Ø¨Ø±Ø§ÛŒ Ø¯Ø³Ú©ØªØ§Ù¾ Ùˆ ØªØ¨Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ */
  @media (min-width: 1024px) {
    .game-container {
      max-width: 500px;
      max-height: 800px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
    }
  }

  /* Ø¨Ø±Ø§ÛŒ ØªØ¨Ù„Øªâ€ŒÙ‡Ø§ */
  @media (min-width: 768px) and (max-width: 1023px) {
    .game-container {
      max-width: 600px;
      max-height: 900px;
    }
  }
</style>
</head>
<body>
<!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
<div class="main-menu" id="mainMenu">
  <h1 class="game-title">Ù‡Ù†ÛŒØ§</h1>
  <div class="high-score" id="highScoreDisplay">Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: 0</div>
  <div class="player-level" id="playerLevelDisplay">Ø³Ø·Ø­: 1</div>
  <div class="menu-buttons">
    <button class="menu-btn" id="startGameBtn">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
    <button class="menu-btn game-modes-btn" id="gameModesBtn">Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ</button>
    <button class="menu-btn theme-btn" id="changeThemeBtn">ØªØºÛŒÛŒØ± ØªÙ…</button>
    <button class="menu-btn customization-btn" id="customizationBtn">Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ</button>
    <button class="menu-btn download-btn" id="downloadBtn">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§Ø²ÛŒ</button>
  </div>
</div>

<!-- ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ… -->
<div class="theme-selection" id="themeSelection">
  <h2 class="theme-title">Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ… Ø¨Ø§Ø²ÛŒ</h2>
  <div class="theme-options">
    <div class="theme-option default" data-theme="default">
      <div class="theme-name">ØªÙ… Ù¾ÛŒØ´â€ŒÙØ±Ø¶</div>
    </div>
    <!-- ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ -->
    <div class="theme-option" data-theme="ocean" style="background: linear-gradient(135deg, #a8e6cf, #dcedc1, #ffd3b6);">
      <div class="theme-name">Ø§Ù‚ÛŒØ§Ù†ÙˆØ³ Ø¢Ø±Ø§Ù…</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û²</div>
    </div>
    <div class="theme-option" data-theme="lavender" style="background: linear-gradient(135deg, #e6e6fa, #d8bfd8, #dda0dd);">
      <div class="theme-name">Ø§Ø³Ø·ÙˆØ®ÙˆØ¯ÙˆØ³</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û³</div>
    </div>
    <div class="theme-option" data-theme="sunset" style="background: linear-gradient(135deg, #ffcccb, #ffb6c1, #ffa07a);">
      <div class="theme-name">ØºØ±ÙˆØ¨ Ø¢ÙØªØ§Ø¨</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û´</div>
    </div>
    <div class="theme-option" data-theme="forest" style="background: linear-gradient(135deg, #98fb98, #90ee90, #adff2f);">
      <div class="theme-name">Ø¬Ù†Ú¯Ù„</div>
      <div class="level-requirement">Ø³Ø·Ø­ Ûµ</div>
    </div>
    <div class="theme-option" data-theme="sky" style="background: linear-gradient(135deg, #87ceeb, #b0e0e6, #add8e6);">
      <div class="theme-name">Ø¢Ø³Ù…Ø§Ù†</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û¶</div>
    </div>
    <div class="theme-option" data-theme="desert" style="background: linear-gradient(135deg, #f5deb3, #f4a460, #daa520);">
      <div class="theme-name">Ø¨ÛŒØ§Ø¨Ø§Ù†</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û·</div>
    </div>
    <div class="theme-option" data-theme="berry" style="background: linear-gradient(135deg, #d8bfd8, #ee82ee, #da70d6);">
      <div class="theme-name">ØªÙˆØª</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û¸</div>
    </div>
    <div class="theme-option" data-theme="mint" style="background: linear-gradient(135deg, #98ff98, #afeeee, #e0ffff);">
      <div class="theme-name">Ù†Ø¹Ù†Ø§Ø¹</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û¹</div>
    </div>
    <div class="theme-option" data-theme="rose" style="background: linear-gradient(135deg, #ffe4e1, #ffb6c1, #ff69b4);">
      <div class="theme-name">Ø±Ø²</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û±Û°</div>
    </div>
  </div>
  <button class="back-btn" id="backToMenuBtn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ</button>
</div>

<!-- ØµÙØ­Ù‡ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ -->
<div class="game-modes-page" id="gameModesPage">
  <h2 class="game-modes-title">Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ</h2>
  <div class="game-modes-container">
    <div class="game-mode active" data-mode="classic">
      <div class="mode-icon">ğŸ®</div>
      <div>Ú©Ù„Ø§Ø³ÛŒÚ©</div>
      <div class="mode-description">Ø­Ø§Ù„Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø§Ø²ÛŒ</div>
    </div>
    <div class="game-mode" data-mode="speed">
      <div class="mode-icon">âš¡</div>
      <div>Ø³Ø±Ø¹Øª</div>
      <div class="mode-description">ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ù…ÛŒâ€ŒØ¢ÛŒÙ†Ø¯</div>
    </div>
    <div class="game-mode" data-mode="survival">
      <div class="mode-icon">â±ï¸</div>
      <div>Ø¨Ù‚Ø§</div>
      <div class="mode-description">Ø²Ù…Ø§Ù† Ù…Ø­Ø¯ÙˆØ¯</div>
    </div>
  </div>
  <button class="back-btn" id="backFromModesBtn">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
</div>

<!-- ØµÙØ­Ù‡ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ -->
<div class="customization-page" id="customizationPage">
  <h2 class="customization-title">Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ</h2>
  <div class="customization-options">
    <div class="customization-option active" data-option="circle" data-type="ballShape">
      <div class="option-icon">â—</div>
      <div>Ø¯Ø§ÛŒØ±Ù‡</div>
      <div class="option-description">Ø´Ú©Ù„ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ ØªÙˆÙ¾â€ŒÙ‡Ø§</div>
    </div>
    <div class="customization-option" data-option="square" data-type="ballShape">
      <div class="option-icon">â– </div>
      <div>Ù…Ø±Ø¨Ø¹</div>
      <div class="option-description">ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ù…Ø±Ø¨Ø¹</div>
    </div>
    <div class="customization-option" data-option="star" data-type="ballShape">
      <div class="option-icon">â˜…</div>
      <div>Ø³ØªØ§Ø±Ù‡</div>
      <div class="option-description">ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ø³ØªØ§Ø±Ù‡</div>
    </div>
    <div class="customization-option" data-option="default" data-type="effects">
      <div class="option-icon">âœ¨</div>
      <div>Ø§ÙÚ©Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯</div>
      <div class="option-description">Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶</div>
    </div>
    <div class="customization-option" data-option="minimal" data-type="effects">
      <div class="option-icon">ğŸ”¹</div>
      <div>Ø§ÙÚ©Øª Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„</div>
      <div class="option-description">Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ Ø³Ø§Ø¯Ù‡</div>
    </div>
    <div class="customization-option" data-option="intense" data-type="effects">
      <div class="option-icon">ğŸ”¥</div>
      <div>Ø§ÙÚ©Øª Ø´Ø¯ÛŒØ¯</div>
      <div class="option-description">Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ Ù¾Ø±Ø§Ù†Ø±Ú˜ÛŒ</div>
    </div>
  </div>
  <button class="back-btn" id="backFromCustomizationBtn">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
</div>

<!-- Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ø²ÛŒ -->
<div class="game-container">
  <div class="title">Ù‡Ù†ÛŒØ§</div>
  <div class="score-container" id="scoreDisplay">Ø§Ù…ØªÛŒØ§Ø²: 0</div>
  <div class="level-container" id="levelDisplay">Ø³Ø·Ø­: 1</div>
  <div class="time-container" id="timeDisplay">Ø²Ù…Ø§Ù†: 60</div>

  <canvas id="game"></canvas>
  <div class="blur-overlay" id="blurOverlay"></div>
  <div class="instructions">Ø¨Ø±Ø§ÛŒ ØªØ¹ÙˆÛŒØ¶ Ø±Ù†Ú¯ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>
  
  <!-- ØµÙØ­Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ -->
  <div class="game-over" id="gameOver">
    <div>Ø´Ù…Ø§ Ø¨Ø§Ø®ØªÛŒ!</div>
    <div>Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ: <span id="finalScore">0</span></div>
    <div class="button-group">
      <button class="restart-btn" onclick="restartGame()">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
      <button class="menu-back-btn" onclick="backToMainMenu()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ</button>
    </div>
  </div>
  
  <!-- ØµÙØ­Ù‡ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­ -->
  <div class="level-up" id="levelUp">
    <div>ØªØ¨Ø±ÛŒÚ©!</div>
    <div>Ø´Ù…Ø§ Ø¨Ù‡ Ø³Ø·Ø­ <span id="newLevel">2</span> Ø±Ø³ÛŒØ¯ÛŒØ¯!</div>
    <div class="button-group">
      <button class="restart-btn" onclick="closeLevelUp()">Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ø²ÛŒ</button>
    </div>
  </div>
    
  <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Ø²ÛŒ -->
  <div class="tutorial" id="tutorial">
    <h3>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Ø²ÛŒ</h3>
    <p>Ø¨Ø±Ø§ÛŒ ØªØ¹ÙˆÛŒØ¶ Ø±Ù†Ú¯ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ† Ú©Ù„ÛŒÚ© Ú©Ù†</p>
    <p>ØªÙˆÙ¾ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø±Ù†Ú¯ Ø¯Ø§ÛŒØ±Ù‡ Ù‡Ù…Ø®ÙˆØ§Ù†ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯</p>
    <p>Ù‡Ø± Ú†Ù‚Ø¯Ø± Ø§Ù…ØªÛŒØ§Ø² Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ú¯ÛŒØ±ÛŒØŒ Ø³Ø±Ø¹Øª Ø¨Ø§Ø²ÛŒ Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
    <p>Ø§Ø² Ù‚Ø¯Ø±Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ù…Ú© Ø¯Ø± Ù…ÙˆØ§Ù‚Ø¹ Ø³Ø®Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†</p>
    <button class="close-tutorial" onclick="closeTutorial()">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
  </div>
</div>

<script>
// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreDisplay = document.getElementById("scoreDisplay");
const levelDisplay = document.getElementById("levelDisplay");
const timeDisplay = document.getElementById("timeDisplay");
const gameOverScreen = document.getElementById("gameOver");
const finalScoreDisplay = document.getElementById("finalScore");
const mainMenu = document.getElementById("mainMenu");
const themeSelection = document.getElementById("themeSelection");
const gameModesPage = document.getElementById("gameModesPage");
const customizationPage = document.getElementById("customizationPage");
const startGameBtn = document.getElementById("startGameBtn");
const gameModesBtn = document.getElementById("gameModesBtn");
const changeThemeBtn = document.getElementById("changeThemeBtn");
const customizationBtn = document.getElementById("customizationBtn");
const downloadBtn = document.getElementById("downloadBtn");
const backToMenuBtn = document.getElementById("backToMenuBtn");
const backFromModesBtn = document.getElementById("backFromModesBtn");
const backFromCustomizationBtn = document.getElementById("backFromCustomizationBtn");
const themeOptions = document.querySelectorAll(".theme-option");
const gameModes = document.querySelectorAll(".game-mode");
const customizationOptions = document.querySelectorAll(".customization-option");
const blurOverlay = document.getElementById("blurOverlay");
const highScoreDisplay = document.getElementById("highScoreDisplay");
const playerLevelDisplay = document.getElementById("playerLevelDisplay");
const levelUpScreen = document.getElementById("levelUp");
const newLevelDisplay = document.getElementById("newLevel");
const tutorial = document.getElementById("tutorial");

let w, h;

// ØªØ¹Ø±ÛŒÙ ØªÙ…â€ŒÙ‡Ø§ Ø¨Ø§ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÙˆØ¹
const themes = {
  'default': {
    background: ['#1a1a2e', '#16213e', '#0f3460'],
    ballColors: ['#393e46', 'white'],
    levelRequired: 1,
    owned: true
  },
  'ocean': {
    background: ['#a8e6cf', '#dcedc1', '#ffd3b6'],
    ballColors: ['#45b7d1', '#96ceb4'],
    levelRequired: 2,
    owned: false
  },
  'lavender': {
    background: ['#e6e6fa', '#d8bfd8', '#dda0dd'],
    ballColors: ['#9370db', '#ba55d3'],
    levelRequired: 3,
    owned: false
  },
  'sunset': {
    background: ['#ffcccb', '#ffb6c1', '#ffa07a'],
    ballColors: ['#ff6347', '#ff4500'],
    levelRequired: 4,
    owned: false
  },
  'forest': {
    background: ['#98fb98', '#90ee90', '#adff2f'],
    ballColors: ['#228b22', '#006400'],
    levelRequired: 5,
    owned: false
  },
  'sky': {
    background: ['#87ceeb', '#b0e0e6', '#add8e6'],
    ballColors: ['#1e90ff', '#0000ff'],
    levelRequired: 6,
    owned: false
  },
  'desert': {
    background: ['#f5deb3', '#f4a460', '#daa520'],
    ballColors: ['#cd853f', '#8b4513'],
    levelRequired: 7,
    owned: false
  },
  'berry': {
    background: ['#d8bfd8', '#ee82ee', '#da70d6'],
    ballColors: ['#c71585', '#8b008b'],
    levelRequired: 8,
    owned: false
  },
  'mint': {
    background: ['#98ff98', '#afeeee', '#e0ffff'],
    ballColors: ['#20b2aa', '#008080'],
    levelRequired: 9,
    owned: false
  },
  'rose': {
    background: ['#ffe4e1', '#ffb6c1', '#ff69b4'],
    ballColors: ['#ff1493', '#c71585'],
    levelRequired: 10,
    owned: false
  }
};

// Ø§Ù†ÙˆØ§Ø¹ ØªÙˆÙ¾â€ŒÙ‡Ø§
const ballTypes = {
  'normal': {
    color: '#393e46',
    value: 1,
    probability: 0.7
  },
  'gold': {
    color: '#ffd700',
    value: 5,
    probability: 0.2
  },
  'diamond': {
    color: '#b9f2ff',
    value: 10,
    probability: 0.08
  },
  'bomb': {
    color: '#ff0000',
    value: -1, // Ø§Ú¯Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨ÛŒØ§ÙØªØ¯ØŒ Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯
    probability: 0.02
  }
};

// Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
const gameModesConfig = {
  'classic': {
    name: 'Ú©Ù„Ø§Ø³ÛŒÚ©',
    description: 'Ø­Ø§Ù„Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø§Ø²ÛŒ',
    speedMultiplier: 1,
    spawnIntervalMultiplier: 1,
    timeLimit: 0,
  },
  'speed': {
    name: 'Ø³Ø±Ø¹Øª',
    description: 'ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ù…ÛŒâ€ŒØ¢ÛŒÙ†Ø¯',
    speedMultiplier: 1.5,
    spawnIntervalMultiplier: 0.7,
    timeLimit: 0,
  },
  'survival': {
    name: 'Ø¨Ù‚Ø§',
    description: 'Ø²Ù…Ø§Ù† Ù…Ø­Ø¯ÙˆØ¯',
    speedMultiplier: 1,
    spawnIntervalMultiplier: 1,
    timeLimit: 60, // 60 Ø«Ø§Ù†ÛŒÙ‡
  },
};

// Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§
const customizationConfig = {
  'ballShape': {
    'circle': {
      name: 'Ø¯Ø§ÛŒØ±Ù‡',
      description: 'Ø´Ú©Ù„ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ ØªÙˆÙ¾â€ŒÙ‡Ø§',
      drawFunction: drawBallCircle
    },
    'square': {
      name: 'Ù…Ø±Ø¨Ø¹',
      description: 'ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ù…Ø±Ø¨Ø¹',
      drawFunction: drawBallSquare
    },
    'star': {
      name: 'Ø³ØªØ§Ø±Ù‡',
      description: 'ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ø³ØªØ§Ø±Ù‡',
      drawFunction: drawBallStar
    }
  },
  'effects': {
    'default': {
      name: 'Ø§ÙÚ©Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯',
      description: 'Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶',
      intensity: 1
    },
    'minimal': {
      name: 'Ø§ÙÚ©Øª Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„',
      description: 'Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ Ø³Ø§Ø¯Ù‡',
      intensity: 0.5
    },
    'intense': {
      name: 'Ø§ÙÚ©Øª Ø´Ø¯ÛŒØ¯',
      description: 'Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ØµØ±ÛŒ Ù¾Ø±Ø§Ù†Ø±Ú˜ÛŒ',
      intensity: 1.5
    }
  }
};

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² localStorage
let currentTheme = localStorage.getItem('hania-theme') || 'default';
let currentGameMode = localStorage.getItem('hania-gameMode') || 'classic';
let currentBallShape = localStorage.getItem('hania-ballShape') || 'circle';
let currentEffects = localStorage.getItem('hania-effects') || 'default';
let highScore = parseInt(localStorage.getItem('hania-highscore')) || 0;
let playerLevel = parseInt(localStorage.getItem('hania-level')) || 1;
let gamesPlayed = parseInt(localStorage.getItem('hania-gamesPlayed')) || 0;
let totalScore = parseInt(localStorage.getItem('hania-totalScore')) || 0;
let maxLevel = parseInt(localStorage.getItem('hania-maxLevel')) || 1;
let ownedThemes = JSON.parse(localStorage.getItem('hania-ownedThemes')) || ['default'];

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø§Ù„Ú©ÛŒØª ØªÙ…â€ŒÙ‡Ø§ Ø§Ø² localStorage
if (ownedThemes) {
  ownedThemes.forEach(themeName => {
    if (themes[themeName]) {
      themes[themeName].owned = true;
    }
  });
}

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
highScoreDisplay.textContent = `Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: ${highScore}`;
playerLevelDisplay.textContent = `Ø³Ø·Ø­: ${playerLevel}`;

let bottomCircles = [];
let balls = [];
let score = 0;
let spawnInterval = 2000;
let speed = 5;
let lastTime = 0;
let clickEffect = null;
let gameActive = false;
let nextSpawnTime = 0;
let frameId = null;
let gameTime = 60; // Ø²Ù…Ø§Ù† Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø¨Ù‚Ø§
let gameTimer = null; // ØªØ§ÛŒÙ…Ø± Ø¨Ø§Ø²ÛŒ

// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
let swapAnimation = {
  active: false,
  startTime: 0,
  duration: 400, // Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ù‡ Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡
  leftCircle: { x: 0, y: 0, color: '' },
  rightCircle: { x: 0, y: 0, color: '' },
  targetLeftX: 0,
  targetRightX: 0
};

// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
let explosions = []; // Ø¨Ø±Ø§ÛŒ Ø§Ù†ÙØ¬Ø§Ø±Ù‡Ø§
let trails = []; // Ø¨Ø±Ø§ÛŒ Ø§Ø«Ø± Ø¯Ù†Ø¨Ø§Ù„Ù‡â€ŒØ¯Ø§Ø±
let sparks = []; // Ø¨Ø±Ø§ÛŒ Ø¬Ø±Ù‚Ù‡â€ŒÙ‡Ø§
let screenShake = { active: false, intensity: 0, duration: 0, startTime: 0 }; // Ø¨Ø±Ø§ÛŒ Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§Ù†ÙˆØ§Ø³
function resizeCanvas() {
  const gameContainer = document.querySelector('.game-container');
  w = gameContainer.clientWidth;
  h = gameContainer.clientHeight;
  
  canvas.width = w;
  canvas.height = h;
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†
  bottomCircles = [
    { x: w / 4, y: h - 50, color: themes[currentTheme].ballColors[0] },
    { x: (3 * w) / 4, y: h - 50, color: themes[currentTheme].ballColors[1] }
  ];
}

// ØªØ§Ø¨Ø¹ stop Ø¨Ø±Ø§ÛŒ ØªÙˆÙ‚Ù Ø¨Ø§Ø²ÛŒ
function stopGame() {
  gameActive = false;
  if (frameId) {
    cancelAnimationFrame(frameId);
    frameId = null;
  }
  if (gameTimer) {
    clearInterval(gameTimer);
    gameTimer = null;
  }
}

// Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
function startGame() {
  // ØªÙ†Ø¸ÛŒÙ… Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§Ù†ÙˆØ§Ø³
  resizeCanvas();
  
  // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
  mainMenu.classList.add("hidden");
  
  // Ù†Ù…Ø§ÛŒØ´ Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ø²ÛŒ
  setTimeout(() => {
    canvas.style.display = "block";
    scoreDisplay.style.display = "block";
    levelDisplay.style.display = "block";
    document.querySelector(".title").style.display = "block";
    document.querySelector(".instructions").style.display = "block";
    
    // ØªÙ†Ø¸ÛŒÙ… ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ
    gameActive = true;
    balls = [];
    explosions = [];
    trails = [];
    sparks = [];
    score = 0;
    scoreDisplay.textContent = "Ø§Ù…ØªÛŒØ§Ø²: " + score;
    levelDisplay.textContent = "Ø³Ø·Ø­: " + playerLevel;
    gameOverScreen.classList.remove("active");
    blurOverlay.style.display = "none";
    levelUpScreen.style.display = "none";
    lastTime = 0;
    nextSpawnTime = 0;
    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø§Ù„Øª Ø¨Ø§Ø²ÛŒ
    const mode = gameModesConfig[currentGameMode];
    speed = 5 * mode.speedMultiplier;
    spawnInterval = 2000 * mode.spawnIntervalMultiplier;
    
    // ØªÙ†Ø¸ÛŒÙ… ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø¨Ù‚Ø§
    if (mode.timeLimit > 0) {
      gameTime = mode.timeLimit;
      timeDisplay.textContent = "Ø²Ù…Ø§Ù†: " + gameTime;
      timeDisplay.style.display = "block";
      gameTimer = setInterval(updateGameTime, 1000);
    } else {
      timeDisplay.style.display = "none";
    }
    
    // Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø²ÛŒ
    if (gamesPlayed === 0) {
      setTimeout(() => {
        tutorial.classList.add("active");
      }, 1000);
    }
    
    // Ø´Ø±ÙˆØ¹ Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ
    if (frameId) {
      cancelAnimationFrame(frameId);
    }
    frameId = requestAnimationFrame(gameLoop);
  }, 500);
}

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø¨Ù‚Ø§
function updateGameTime() {
  if (!gameActive) return;
  
  gameTime--;
  timeDisplay.textContent = "Ø²Ù…Ø§Ù†: " + gameTime;
  
  if (gameTime <= 0) {
    gameOver();
  }
}

// Ø¨Ø³ØªÙ† Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
function closeTutorial() {
  tutorial.classList.remove("active");
}

// Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
function backToMainMenu() {
  // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ø²ÛŒ
  canvas.style.display = "none";
  scoreDisplay.style.display = "none";
  levelDisplay.style.display = "none";
  timeDisplay.style.display = "none";
  document.querySelector(".title").style.display = "none";
  document.querySelector(".instructions").style.display = "none";
  gameOverScreen.classList.remove("active");
  blurOverlay.style.display = "none";
  levelUpScreen.style.display = "none";
  tutorial.classList.remove("active");
  
  // Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
  mainMenu.classList.remove("hidden");
  
  // ØªÙˆÙ‚Ù Ø¨Ø§Ø²ÛŒ
  stopGame();
}

// ØªØºÛŒÛŒØ± ØªÙ…
function changeTheme(themeName) {

  currentTheme = themeName;
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ù†Ú¯ ØªÙˆÙ¾â€ŒÙ‡Ø§
  bottomCircles[0].color = themes[themeName].ballColors[0];
  bottomCircles[1].color = themes[themeName].ballColors[1];
  
  // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
  localStorage.setItem('hania-theme', themeName);
  
  // Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ… Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
  themeSelection.classList.remove("active");
}

// ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª Ø¨Ø§Ø²ÛŒ
function changeGameMode(modeName) {
  currentGameMode = modeName;
  localStorage.setItem('hania-gameMode', modeName);
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
  gameModes.forEach(mode => {
    if (mode.getAttribute('data-mode') === modeName) {
      mode.classList.add('active');
    } else {
      mode.classList.remove('active');
    }
  });
}

// ØªØºÛŒÛŒØ± Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ
function changeCustomization(optionName, type) {
  if (type === 'ballShape') {
    currentBallShape = optionName;
    localStorage.setItem('hania-ballShape', optionName);
  } else if (type === 'effects') {
    currentEffects = optionName;
    localStorage.setItem('hania-effects', optionName);
  }
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§
  customizationOptions.forEach(option => {
    if (option.getAttribute('data-option') === optionName && option.getAttribute('data-type') === type) {
      option.classList.add('active');
    } else if (option.getAttribute('data-type') === type) {
      option.classList.remove('active');
    }
  });
}

// Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø·Ø­ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù‚ÙÙ„â€ŒÚ¯Ø°Ø§Ø±ÛŒ ØªÙ…â€ŒÙ‡Ø§
function updateThemeLocks() {
  const themeOptions = document.querySelectorAll('.theme-option');
  
  themeOptions.forEach(option => {
    const themeName = option.getAttribute('data-theme');
    const levelRequired = themes[themeName].levelRequired;
    const owned = themes[themeName].owned;
    
    if (owned || (playerLevel >= levelRequired)) {
      option.classList.remove('locked');
      const lockIcon = option.querySelector('.lock-icon');
      if (lockIcon) lockIcon.remove();

    } else {
      option.classList.add('locked');
      if (!option.querySelector('.lock-icon')) {
        const lockIcon = document.createElement('div');
        lockIcon.className = 'lock-icon';
        lockIcon.innerHTML = 'ğŸ”’';
        option.appendChild(lockIcon);
      }
    }
  });
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ø§ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ Ø³Ù…Øªâ€ŒÙ‡Ø§
function spawnBalls() {
  const ballColors = themes[currentTheme].ballColors;
  
  // Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ØªÙˆÙ¾ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø­ØªÙ…Ø§Ù„
  let ballType = 'normal';
  const rand = Math.random();
  let cumulative = 0;
  
  for (const type in ballTypes) {
    cumulative += ballTypes[type].probability;
    if (rand <= cumulative) {
      ballType = type;
      break;
    }
  }
  
  // ØªØ¹ÛŒÛŒÙ† Ø±Ù†Ú¯ ØªÙˆÙ¾â€ŒÙ‡Ø§
  let leftColor, rightColor;
  if (Math.random() < 0.5) {
    leftColor = ballColors[0];
    rightColor = ballColors[1];
  } else {
    leftColor = ballColors[1];
    rightColor = ballColors[0];
  }
  
  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ø§ Ù†ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
  balls.push({ 
    x: w / 4, 
    y: 0, 
    color: leftColor,
    type: ballType,
    value: ballTypes[ballType].value
  });
  
  balls.push({ 
    x: (3 * w) / 4, 
    y: 0, 
    color: rightColor,
    type: ballType,
    value: ballTypes[ballType].value
  });
}

// Ø±Ø³Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ø¯Ø§ÛŒØ±Ù‡
function drawBallCircle(x, y, color, type = 'normal', r = 20) {
  // ØªÙ†Ø¸ÛŒÙ… Ø´Ø¹Ø§Ø¹ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ­Ù‡
  const radius = Math.max(15, r * (Math.min(w, h) / 400));
  
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  
  // Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
  let gradient;
  const isLightColor = color === 'white' || color === '#ffd700' || color === '#00ff7f' || color === '#00bfff' || color === '#00ced1' || color === '#00ffff';
  
  if (isLightColor) {
    gradient = ctx.createRadialGradient(x-6, y-6, 3, x, y, radius);
    gradient.addColorStop(0, "#ffffff");
    gradient.addColorStop(0.6, "#d0d0d0");
    gradient.addColorStop(1, "#a0a0a0");
  } else {
    gradient = ctx.createRadialGradient(x-6, y-6, 3, x, y, radius);
    gradient.addColorStop(0, lightenColor(color, 30));
    gradient.addColorStop(0.6, color);
    gradient.addColorStop(1, darkenColor(color, 20));
  }
  
  ctx.fillStyle = gradient;
  ctx.shadowColor = isLightColor ? "rgba(255,255,255,0.5)" : "rgba(0,0,0,0.7)";
  ctx.shadowBlur = 10;
  ctx.fill();
  
  // Ø¯Ø±Ø®Ø´Ø´ Ø¯Ø§Ø®Ù„ÛŒ
  ctx.beginPath();
  ctx.arc(x, y, radius-5, 0, Math.PI * 2);
  ctx.strokeStyle = isLightColor ? "rgba(255,255,255,0.4)" : "rgba(100,100,100,0.4)";
  ctx.lineWidth = 1;
  ctx.stroke();
  
  // Ù†Ù‚Ø·Ù‡ Ø¨Ø±Ø§Ù‚
  ctx.beginPath();
  ctx.arc(x-5, y-5, 4, 0, Math.PI * 2);
  ctx.fillStyle = isLightColor ? "rgba(255,255,255,0.9)" : "rgba(180,180,180,0.7)";
  ctx.fill();
  
  // Ø±Ø³Ù… Ù†Ù…Ø§Ø¯ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ
  if (type !== 'normal') {
    ctx.fillStyle = type === 'gold' ? '#ffd700' : 
                   type === 'diamond' ? '#b9f2ff' : 
                   '#ff0000';
    
    if (type === 'gold') {
      // Ø³ØªØ§Ø±Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø·Ù„Ø§ÛŒÛŒ
      drawStar(x, y, 5, radius * 0.6, radius * 0.3);
      ctx.fill();
    } else if (type === 'diamond') {
      // Ø§Ù„Ù…Ø§Ø³ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø§Ù„Ù…Ø§Ø³ÛŒ
      drawDiamond(x, y, radius * 0.7);
      ctx.fill();
    } else if (type === 'bomb') {
      // Ø´Ø¹Ù„Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø¨Ù…Ø¨
      drawFlame(x, y, radius * 0.7);
      ctx.fill();
    }
  }
}

// Ø±Ø³Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ù…Ø±Ø¨Ø¹
function drawBallSquare(x, y, color, type = 'normal', r = 20) {
  // ØªÙ†Ø¸ÛŒÙ… Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ­Ù‡
  const size = Math.max(15, r * (Math.min(w, h) / 400));
  
  ctx.beginPath();
  ctx.rect(x - size, y - size, size * 2, size * 2);
  
  // Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
  let gradient;
  const isLightColor = color === 'white' || color === '#ffd700' || color === '#00ff7f' || color === '#00bfff' || color === '#00ced1' || color === '#00ffff';
  
  if (isLightColor) {
    gradient = ctx.createLinearGradient(x - size, y - size, x + size, y + size);
    gradient.addColorStop(0, "#ffffff");
    gradient.addColorStop(0.6, "#d0d0d0");
    gradient.addColorStop(1, "#a0a0a0");
  } else {
    gradient = ctx.createLinearGradient(x - size, y - size, x + size, y + size);
    gradient.addColorStop(0, lightenColor(color, 30));
    gradient.addColorStop(0.6, color);
    gradient.addColorStop(1, darkenColor(color, 20));
  }
  
  ctx.fillStyle = gradient;
  ctx.shadowColor = isLightColor ? "rgba(255,255,255,0.5)" : "rgba(0,0,0,0.7)";
  ctx.shadowBlur = 10;
  ctx.fill();
  
  // Ø­Ø§Ø´ÛŒÙ‡
  ctx.strokeStyle = isLightColor ? "rgba(255,255,255,0.4)" : "rgba(100,100,100,0.4)";
  ctx.lineWidth = 1;
  ctx.stroke();
  
  // Ø±Ø³Ù… Ù†Ù…Ø§Ø¯ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ
  if (type !== 'normal') {
    ctx.fillStyle = type === 'gold' ? '#ffd700' : 
                   type === 'diamond' ? '#b9f2ff' : 
                   '#ff0000';
    
    if (type === 'gold') {
      // Ø³ØªØ§Ø±Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø·Ù„Ø§ÛŒÛŒ
      drawStar(x, y, 5, size * 0.6, size * 0.3);
      ctx.fill();
    } else if (type === 'diamond') {
      // Ø§Ù„Ù…Ø§Ø³ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø§Ù„Ù…Ø§Ø³ÛŒ
      drawDiamond(x, y, size * 0.7);
      ctx.fill();
    } else if (type === 'bomb') {
      // Ø´Ø¹Ù„Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø¨Ù…Ø¨
      drawFlame(x, y, size * 0.7);
      ctx.fill();
    }
  }
}

// Ø±Ø³Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ø³ØªØ§Ø±Ù‡
function drawBallStar(x, y, color, type = 'normal', r = 20) {
  // ØªÙ†Ø¸ÛŒÙ… Ø´Ø¹Ø§Ø¹ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ­Ù‡
  const radius = Math.max(15, r * (Math.min(w, h) / 400));
  
  // Ø±Ø³Ù… Ø³ØªØ§Ø±Ù‡
  drawStar(x, y, 5, radius, radius * 0.5);
  
  // Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
  let gradient;
  const isLightColor = color === 'white' || color === '#ffd700' || color === '#00ff7f' || color === '#00bfff' || color === '#00ced1' || color === '#00ffff';
  
  if (isLightColor) {
    gradient = ctx.createRadialGradient(x-6, y-6, 3, x, y, radius);
    gradient.addColorStop(0, "#ffffff");
    gradient.addColorStop(0.6, "#d0d0d0");
    gradient.addColorStop(1, "#a0a0a0");
  } else {
    gradient = ctx.createRadialGradient(x-6, y-6, 3, x, y, radius);
    gradient.addColorStop(0, lightenColor(color, 30));
    gradient.addColorStop(0.6, color);
    gradient.addColorStop(1, darkenColor(color, 20));
  }
  
  ctx.fillStyle = gradient;
  ctx.shadowColor = isLightColor ? "rgba(255,255,255,0.5)" : "rgba(0,0,0,0.7)";
  ctx.shadowBlur = 10;
  ctx.fill();
  
  // Ø±Ø³Ù… Ù†Ù…Ø§Ø¯ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ
  if (type !== 'normal') {
    ctx.fillStyle = type === 'gold' ? '#ffd700' : 
                   type === 'diamond' ? '#b9f2ff' : 
                   '#ff0000';
    
    if (type === 'gold') {
      // Ø³ØªØ§Ø±Ù‡ Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø·Ù„Ø§ÛŒÛŒ
      drawStar(x, y, 5, radius * 0.4, radius * 0.2);
      ctx.fill();
    } else if (type === 'diamond') {
      // Ø§Ù„Ù…Ø§Ø³ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø§Ù„Ù…Ø§Ø³ÛŒ
      drawDiamond(x, y, radius * 0.5);
      ctx.fill();
    } else if (type === 'bomb') {
      // Ø´Ø¹Ù„Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾ Ø¨Ù…Ø¨
      drawFlame(x, y, radius * 0.5);
      ctx.fill();
    }
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø³ØªØ§Ø±Ù‡
function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
  let rot = Math.PI / 2 * 3;
  let x = cx;
  let y = cy;
  let step = Math.PI / spikes;

  ctx.beginPath();
  ctx.moveTo(cx, cy - outerRadius);
  
  for (let i = 0; i < spikes; i++) {
    x = cx + Math.cos(rot) * outerRadius;
    y = cy + Math.sin(rot) * outerRadius;
    ctx.lineTo(x, y);
    rot += step;

    x = cx + Math.cos(rot) * innerRadius;
    y = cy + Math.sin(rot) * innerRadius;
    ctx.lineTo(x, y);
    rot += step;
  }
  
  ctx.lineTo(cx, cy - outerRadius);
  ctx.closePath();
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø§Ù„Ù…Ø§Ø³
function drawDiamond(cx, cy, size) {
  ctx.beginPath();
  ctx.moveTo(cx, cy - size);
  ctx.lineTo(cx + size, cy);
  ctx.lineTo(cx, cy + size);
  ctx.lineTo(cx - size, cy);
  ctx.closePath();
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø´Ø¹Ù„Ù‡
function drawFlame(cx, cy, size) {
  ctx.beginPath();
  ctx.moveTo(cx, cy - size);
  ctx.quadraticCurveTo(cx + size, cy - size/2, cx, cy + size);
  ctx.quadraticCurveTo(cx - size, cy - size/2, cx, cy - size);
  ctx.closePath();
}

// Ø±Ø³Ù… Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø§ Ø¸Ø§Ù‡Ø± Ø²ÛŒØ¨Ø§
function drawBottomCircle(x, y, color, r = 30) {
  // ØªÙ†Ø¸ÛŒÙ… Ø´Ø¹Ø§Ø¹ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ­Ù‡
  const radius = Math.max(20, r * (Math.min(w, h) / 400));
  
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  
  // Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†
  let gradient;
  const isLightColor = color === 'white' || color === '#ffd700' || color === '#00ff7f' || color === '#00bfff' || color === '#00ced1' || color === '#00ffff';
  
  if (isLightColor) {
    gradient = ctx.createRadialGradient(x-8, y-8, 5, x, y, radius);
    gradient.addColorStop(0, "#ffffff");
    gradient.addColorStop(0.7, "#e0e0e0");
    gradient.addColorStop(1, "#c0c0c0");
  } else {
    gradient = ctx.createRadialGradient(x-8, y-8, 5, x, y, radius);
    gradient.addColorStop(0, lightenColor(color, 40));
    gradient.addColorStop(0.7, color);
    gradient.addColorStop(1, darkenColor(color, 20));
  }
  
  ctx.fillStyle = gradient;
  ctx.shadowColor = isLightColor ? "rgba(255,255,255,0.5)" : "rgba(100,100,100,0.5)";
  ctx.shadowBlur = 15;
  ctx.shadowOffsetX = 2;
  ctx.shadowOffsetY = 2;
  ctx.fill();
  
  // Ø­Ø§Ø´ÛŒÙ‡ Ø¨Ø±Ø§Ù‚
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.strokeStyle = isLightColor ? "rgba(255,255,255,0.8)" : "rgba(150,150,150,0.8)";
  ctx.lineWidth = 2;
  ctx.stroke();
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø±Ù†Ú¯
function lightenColor(color, percent) {
  if (color.startsWith('#')) {
    const num = parseInt(color.slice(1), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    return `#${(0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1)}`;
  }
  return color;
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªÛŒØ±Ù‡ Ú©Ø±Ø¯Ù† Ø±Ù†Ú¯
function darkenColor(color, percent) {
  if (color.startsWith('#')) {
    const num = parseInt(color.slice(1), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) - amt;
    const G = (num >> 8 & 0x00FF) - amt;
    const B = (num & 0x0000FF) - amt;
    return `#${(0x1000000 + (R > 0 ? R : 0) * 0x10000 +
            (G > 0 ? G : 0) * 0x100 +
            (B > 0 ? B : 0)).toString(16).slice(1)}`;
  }
  return color;
}

// Ø±Ø³Ù… Ø§ÙÚ©Øª Ú©Ù„ÛŒÚ©
function drawClickEffect() {
  if (clickEffect) {
    const elapsed = Date.now() - clickEffect.startTime;
    const progress = Math.min(elapsed / 300, 1); // 300ms duration
    const alpha = 1 - progress;
    const radius = 30 + progress * 40;
    
    ctx.beginPath();
    ctx.arc(clickEffect.x, clickEffect.y, radius, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(255, 215, 0, ${alpha})`;
    ctx.lineWidth = 3;
    ctx.stroke();
    
    if (progress >= 1) {
      clickEffect = null;
    }
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
function drawSwapAnimation() {
  if (!swapAnimation.active) return;
  
  const elapsed = Date.now() - swapAnimation.startTime;
  const progress = Math.min(elapsed / swapAnimation.duration, 1);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ easeOutCubic Ø¨Ø±Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†Ø±Ù…
  const easedProgress = 1 - Math.pow(1 - progress, 3);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
  const leftX = swapAnimation.leftCircle.x + (swapAnimation.targetLeftX - swapAnimation.leftCircle.x) * easedProgress;
  const rightX = swapAnimation.rightCircle.x + (swapAnimation.targetRightX - swapAnimation.rightCircle.x) * easedProgress;
  
  // Ø±Ø³Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ
  drawBottomCircle(leftX, swapAnimation.leftCircle.y, swapAnimation.leftCircle.color);
  drawBottomCircle(rightX, swapAnimation.rightCircle.y, swapAnimation.rightCircle.color);
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ù…ØªØµÙ„ Ú©Ù†Ù†Ø¯Ù‡
  ctx.beginPath();
  ctx.moveTo(leftX, swapAnimation.leftCircle.y);
  ctx.lineTo(rightX, swapAnimation.rightCircle.y);
  ctx.strokeStyle = `rgba(255, 255, 255, ${0.5 * (1 - progress)})`;
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // Ø§Ú¯Ø± Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
  if (progress >= 1) {
    swapAnimation.active = false;
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†ÙØ¬Ø§Ø±
function createExplosion(x, y, color) {
  const particles = [];
  const particleCount = 15;
  
  for (let i = 0; i < particleCount; i++) {
    particles.push({
      x: x,
      y: y,
      size: Math.random() * 5 + 2,
      speedX: (Math.random() - 0.5) * 10,
      speedY: (Math.random() - 0.5) * 10,
      color: color,
      life: 1.0,
      decay: Math.random() * 0.05 + 0.02
    });
  }
  
  explosions.push({
    particles: particles,
    startTime: Date.now()
  });
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø§Ù†ÙØ¬Ø§Ø±Ù‡Ø§
function drawExplosions() {
  for (let i = explosions.length - 1; i >= 0; i--) {
    const explosion = explosions[i];
    const elapsed = Date.now() - explosion.startTime;
    
    // Ø§Ú¯Ø± Ø§Ù†ÙØ¬Ø§Ø± Ù‚Ø¯ÛŒÙ…ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø­Ø°ÙØ´ Ú©Ù†
    if (elapsed > 1000) {
      explosions.splice(i, 1);
      continue;
    }
    
    // Ø±Ø³Ù… ØªÙ…Ø§Ù… Ø°Ø±Ø§Øª Ø§Ù†ÙØ¬Ø§Ø±
    for (let j = 0; j < explosion.particles.length; j++) {
      const p = explosion.particles[j];
      
      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª
      p.x += p.speedX;
      p.y += p.speedY;
      p.life -= p.decay;
      
      // Ø§Ú¯Ø± Ø°Ø±Ù‡ Ù‡Ù†ÙˆØ² Ø²Ù†Ø¯Ù‡ Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø±Ø³Ù… Ú©Ù†
      if (p.life > 0) {
        ctx.globalAlpha = p.life;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();
        ctx.globalAlpha = 1.0;
      }
    }
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø«Ø± Ø¯Ù†Ø¨Ø§Ù„Ù‡â€ŒØ¯Ø§Ø±
function createTrail(x, y, color) {
  trails.push({
    x: x,
    y: y,
    color: color,
    life: 1.0,
    decay: 0.05,
    size: Math.random() * 10 + 5
  });
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø§Ø«Ø±Ø§Øª Ø¯Ù†Ø¨Ø§Ù„Ù‡â€ŒØ¯Ø§Ø±
function drawTrails() {
  for (let i = trails.length - 1; i >= 0; i--) {
    const trail = trails[i];
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù…Ø±
    trail.life -= trail.decay;
    
    // Ø§Ú¯Ø± Ø§Ø«Ø± Ù‡Ù†ÙˆØ² Ø²Ù†Ø¯Ù‡ Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø±Ø³Ù… Ú©Ù†
    if (trail.life > 0) {
      ctx.globalAlpha = trail.life;
      ctx.beginPath();
      ctx.arc(trail.x, trail.y, trail.size, 0, Math.PI * 2);
      ctx.fillStyle = trail.color;
      ctx.fill();
      ctx.globalAlpha = 1.0;
    } else {
      // Ø§Ú¯Ø± Ø¹Ù…Ø±Ø´ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ØŒ Ø­Ø°ÙØ´ Ú©Ù†
      trails.splice(i, 1);
    }
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø±Ù‚Ù‡
function createSparks(x, y, count = 8) {
  for (let i = 0; i < count; i++) {
    sparks.push({
      x: x,
      y: y,
      size: Math.random() * 3 + 1,
      speedX: (Math.random() - 0.5) * 8,
      speedY: (Math.random() - 0.5) * 8,
      color: '#FFD700', // Ø±Ù†Ú¯ Ø·Ù„Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ø±Ù‚Ù‡
      life: 1.0,
      decay: Math.random() * 0.1 + 0.05
    });
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø¬Ø±Ù‚Ù‡â€ŒÙ‡Ø§
function drawSparks() {
  for (let i = sparks.length - 1; i >= 0; i--) {
    const spark = sparks[i];
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ø¹Ù…Ø±
    spark.x += spark.speedX;
    spark.y += spark.speedY;
    spark.life -= spark.decay;
    
    // Ø§Ú¯Ø± Ø¬Ø±Ù‚Ù‡ Ù‡Ù†ÙˆØ² Ø²Ù†Ø¯Ù‡ Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø±Ø³Ù… Ú©Ù†
    if (spark.life > 0) {
      ctx.globalAlpha = spark.life;
      ctx.beginPath();
      ctx.arc(spark.x, spark.y, spark.size, 0, Math.PI * 2);
      ctx.fillStyle = spark.color;
      ctx.fill();
      ctx.globalAlpha = 1.0;
    } else {
      // Ø§Ú¯Ø± Ø¹Ù…Ø±Ø´ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ØŒ Ø­Ø°ÙØ´ Ú©Ù†
      sparks.splice(i, 1);
    }
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡
function triggerScreenShake(intensity = 5, duration = 500) {
  screenShake.active = true;
  screenShake.intensity = intensity;
  screenShake.duration = duration;
  screenShake.startTime = Date.now();
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡
function applyScreenShake() {
  if (!screenShake.active) return { x: 0, y: 0 };
  
  const elapsed = Date.now() - screenShake.startTime;
  const progress = Math.min(elapsed / screenShake.duration, 1);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Øª Ù„Ø±Ø²Ø´ (Ú©Ø§Ù‡Ø´ ØªØ¯Ø±ÛŒØ¬ÛŒ)
  const currentIntensity = screenShake.intensity * (1 - progress);
  
  // Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªØµØ§Ø¯ÙÛŒ
  const offsetX = (Math.random() - 0.5) * currentIntensity;
  const offsetY = (Math.random() - 0.5) * currentIntensity;
  
  // Ø§Ú¯Ø± Ù„Ø±Ø²Ø´ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
  if (progress >= 1) {
    screenShake.active = false;
  }
  
  return { x: offsetX, y: offsetY };
}

// Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Object Pooling Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
const ballPool = {
  pool: [],
  get: function(x, y, color, type, value) {
    if (this.pool.length > 0) {
      const ball = this.pool.pop();
      ball.x = x;
      ball.y = y;
      ball.color = color;
      ball.type = type;
      ball.value = value;
      return ball;
    }
    return { x, y, color, type, value };
  },
  release: function(ball) {
    this.pool.push(ball);
  }
};

// Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Spatial Partitioning Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø¨Ø±Ø®ÙˆØ±Ø¯
const spatialGrid = {
  cellSize: 50,
  grid: {},
  
  clear: function() {
    this.grid = {};
  },
  
  addBall: function(ball) {
    const cellX = Math.floor(ball.x / this.cellSize);
    const cellY = Math.floor(ball.y / this.cellSize);
    const key = `${cellX},${cellY}`;
    
    if (!this.grid[key]) {
      this.grid[key] = [];
    }
    this.grid[key].push(ball);
  },
  
  getNearbyBalls: function(x, y) {
    const cellX = Math.floor(x / this.cellSize);
    const cellY = Math.floor(y / this.cellSize);
    const result = [];
    
    for (let dx = -1; dx <= 1; dx++) {
      for (let dy = -1; dy <= 1; dy++) {
        const key = `${cellX + dx},${cellY + dy}`;
        if (this.grid[key]) {
          result.push(...this.grid[key]);
        }
      }
    }
    
    return result;
  }
};

// Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­ (Ù‡Ø± 50 Ø§Ù…ØªÛŒØ§Ø²)
function checkLevelUp() {
  const newLevel = Math.min(10, Math.floor(score / 50) + 1);
  
  if (newLevel > playerLevel) {
    playerLevel = newLevel;
    localStorage.setItem('hania-level', playerLevel);
    playerLevelDisplay.textContent = `Ø³Ø·Ø­: ${playerLevel}`;
    levelDisplay.textContent = `Ø³Ø·Ø­: ${playerLevel}`;
    
    // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­
    newLevelDisplay.textContent = playerLevel;
    levelUpScreen.style.display = "flex";
    
    // ØªÙˆÙ‚Ù Ø¨Ø§Ø²ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­
    stopGame();
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÙÙ„ ØªÙ…â€ŒÙ‡Ø§
    updateThemeLocks();
    
    return true;
  }
  return false;
}

// Ø¨Ø³ØªÙ† ØµÙØ­Ù‡ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­
function closeLevelUp() {
  levelUpScreen.style.display = "none";
  
  // Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ø²ÛŒ
  gameActive = true;
  frameId = requestAnimationFrame(gameLoop);
}

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª ØªÙˆÙ¾â€ŒÙ‡Ø§
function update(deltaTime) {
  if (!gameActive) return;
  
  ctx.clearRect(0, 0, w, h);
  
  // Ø§Ø¹Ù…Ø§Ù„ Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡
  const shakeOffset = applyScreenShake();
  ctx.save();
  ctx.translate(shakeOffset.x, shakeOffset.y);
  
  // Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø²ÛŒØ¨Ø§
  const gradient = ctx.createLinearGradient(0, 0, 0, h);
  const themeColors = themes[currentTheme].background;
  gradient.addColorStop(0, themeColors[0]);
  gradient.addColorStop(0.5, themeColors[1]);
  gradient.addColorStop(1, themeColors[2]);
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, w, h);
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø±Ø§Ù‡Ù†Ù…Ø§
  ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(w/2, 0);
  ctx.lineTo(w/2, h);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø´Ø¨Ú©Ù‡ ÙØ¶Ø§ÛŒÛŒ
  spatialGrid.clear();
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø±Ø¹Øª Ø¨Ø§ Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ† Ù‚Ø¯Ø±Øª Ú©Ù†Ø¯ Ú©Ø±Ø¯Ù†
  let currentSpeed = speed;
  
  // Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª ØªÙˆÙ¾â€ŒÙ‡Ø§ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ ÙØ¶Ø§ÛŒÛŒ
  for (let i = 0; i < balls.length; i++) {
    const b = balls[i];
    b.y += currentSpeed * (deltaTime / 16);
    spatialGrid.addBall(b);
    
    // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø«Ø± Ø¯Ù†Ø¨Ø§Ù„Ù‡â€ŒØ¯Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
    if (Math.random() < 0.3) {
      createTrail(b.x, b.y, b.color);
    }
  }
  
  // Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: ØªØ´Ø®ÛŒØµ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø´Ø¨Ú©Ù‡ ÙØ¶Ø§ÛŒÛŒ
  for (let i = balls.length - 1; i >= 0; i--) {
    const b = balls[i];
    
    // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†
    if (b.y > h - 80) {
      // Ø§ÛŒÙ† Ù‚Ø³Ù…Øª Ú©Ù„ÛŒØ¯ÛŒ Ø§Ø³Øª - Ø¨Ø§ÛŒØ¯ Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ ØªÙˆÙ¾ Ø±Ø§ Ø¨Ø§ Ø±Ù†Ú¯ ØªÙˆÙ¾â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ† Ù…Ù‚Ø§ÛŒØ³Ù‡ Ú©Ù†ÛŒÙ…
      // Ù†Ù‡ Ø¨Ø§ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø§Ø¨Øª Ø¢Ù†â€ŒÙ‡Ø§
      let target;
      if (b.x < w / 2) {
        // ØªÙˆÙ¾ Ø¯Ø± Ø³Ù…Øª Ú†Ù¾ Ø§Ø³Øª
        target = bottomCircles[0];
      } else {
        // ØªÙˆÙ¾ Ø¯Ø± Ø³Ù…Øª Ø±Ø§Ø³Øª Ø§Ø³Øª
        target = bottomCircles[1];
      }
      
      if (b.color === target.color) {
        // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†ÙØ¬Ø§Ø±
        createExplosion(b.x, b.y, b.color);
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ† Ù‚Ø¯Ø±Øª Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ú©Ø±Ø¯Ù† Ùˆ Ø­Ø§Ù„Øª Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ§ÛŒ
        let points = b.value;
        
        score += points;
        scoreDisplay.textContent = "Ø§Ù…ØªÛŒØ§Ø²: " + score;
        
        ballPool.release(balls[i]);
        balls.splice(i, 1); // Ø­Ø°Ù ØªÙˆÙ¾ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±Ø®ÙˆØ±Ø¯ ØµØ­ÛŒØ­
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­
        checkLevelUp();
      } else {
        // Ø§Ú¯Ø± ØªÙˆÙ¾ Ø¨Ù…Ø¨ Ø¨Ø§Ø´Ø¯ Ùˆ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨ÛŒØ§ÙØªØ¯
        if (b.type === 'bomb') {
          // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡
          triggerScreenShake(15, 800);
          
          // ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
          if (gameActive) {
            gameOver();
          }
        } else {
          // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡
          triggerScreenShake(8, 400);
          
          // ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
          if (gameActive && !gameModesConfig[currentGameMode].practice) {
            gameOver();
          }
          // ØªÙˆÙ¾ Ø­Ø°Ù Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¯Ø± Ø¬Ø§ÛŒ Ø®ÙˆØ¯ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
        }
      }
    }
  }
  
  // Ø±Ø³Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ø§ Ø´Ú©Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
  for (let i = 0; i < balls.length; i++) {
    const b = balls[i];
    const drawFunction = customizationConfig.ballShape[currentBallShape].drawFunction;
    drawFunction(b.x, b.y, b.color, b.type, 20);
  }

  // Ø±Ø³Ù… Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ† (Ø§Ú¯Ø± Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª)
  if (!swapAnimation.active) {
    for (let c of bottomCircles) {
      drawBottomCircle(c.x, c.y, c.color);
    }
  }
  
  // Ø±Ø³Ù… Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§ (Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯)
  drawSwapAnimation();
  
  // Ø±Ø³Ù… Ø§ÙÚ©Øª Ú©Ù„ÛŒÚ©
  drawClickEffect();
  
  // Ø±Ø³Ù… Ø§Ù†ÙØ¬Ø§Ø±Ù‡Ø§
  drawExplosions();
  
  // Ø±Ø³Ù… Ø§Ø«Ø±Ø§Øª Ø¯Ù†Ø¨Ø§Ù„Ù‡â€ŒØ¯Ø§Ø±
  drawTrails();
  
  // Ø±Ø³Ù… Ø¬Ø±Ù‚Ù‡â€ŒÙ‡Ø§
  drawSparks();
  
  ctx.restore();
}

// Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ (Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡)
function gameLoop(timestamp) {
  if (!lastTime) lastTime = timestamp;
  const deltaTime = timestamp - lastTime;
  lastTime = timestamp;

  // Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ¾â€ŒÙ‡Ø§
  if (gameActive && timestamp > nextSpawnTime) {
    spawnBalls();
    nextSpawnTime = timestamp + spawnInterval;
    
    // Ø§ÙØ²Ø§ÛŒØ´ Ø³Ø±Ø¹Øª Ùˆ Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²
    if (score > 0 && score % 5 === 0) {
      speed = Math.min(10, 5 + Math.floor(score / 5));
      spawnInterval = Math.max(800, 2000 - Math.floor(score / 5) * 100);
    }
  }

  update(deltaTime);
  frameId = requestAnimationFrame(gameLoop);
}

// Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ
function gameOver() {
  gameActive = false;
  finalScoreDisplay.textContent = score;
  
  // Ø°Ø®ÛŒØ±Ù‡ Ø¢Ù…Ø§Ø±
  gamesPlayed++;
  totalScore += score;
  if (playerLevel > maxLevel) {
    maxLevel = playerLevel;
  }
  
  // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
  localStorage.setItem('hania-highscore', Math.max(highScore, score));
  localStorage.setItem('hania-gamesPlayed', gamesPlayed);
  localStorage.setItem('hania-totalScore', totalScore);
  localStorage.setItem('hania-maxLevel', maxLevel);
  
  // Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª
  localStorage.setItem('hania-auto-save', JSON.stringify({
    score: score,
    level: playerLevel,
    balls: balls.length,
    timestamp: Date.now()
  }));
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²
  if (score > highScore) {
    highScore = score;
    highScoreDisplay.textContent = `Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: ${highScore}`;
  }
  
  // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ
  gameOverScreen.classList.add("active");
  blurOverlay.style.display = "block";
}

// Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§Ø²ÛŒ
function restartGame() {
  // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø§Ø³ØªØ®Ø±
  for (let ball of balls) {
    ballPool.release(ball);
  }
  balls = [];
  explosions = [];
  trails = [];
  sparks = [];
  
  score = 0;
  const mode = gameModesConfig[currentGameMode];
  speed = 5 * mode.speedMultiplier;
  spawnInterval = 2000 * mode.spawnIntervalMultiplier;
  
  scoreDisplay.textContent = "Ø§Ù…ØªÛŒØ§Ø²: " + score;
  gameActive = true;
  gameOverScreen.classList.remove("active");
  blurOverlay.style.display = "none";
  levelUpScreen.style.display = "none";
  lastTime = 0;
  nextSpawnTime = 0;
  
  // ØªÙ†Ø¸ÛŒÙ… ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø¨Ù‚Ø§
  if (mode.timeLimit > 0) {
    gameTime = mode.timeLimit;
    timeDisplay.textContent = "Ø²Ù…Ø§Ù†: " + gameTime;
    timeDisplay.style.display = "block";
    if (gameTimer) clearInterval(gameTimer);
    gameTimer = setInterval(updateGameTime, 1000);
  } else {
    timeDisplay.style.display = "none";
  }
  
  // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ
  if (frameId) {
    cancelAnimationFrame(frameId);
  }
  frameId = requestAnimationFrame(gameLoop);
}

// ØªØ¹ÙˆÛŒØ¶ Ø±Ù†Ú¯ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ú©Ù„ÛŒÚ© (Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†)
function handleCanvasClick(x, y) {
  if (!gameActive || swapAnimation.active) return;
  
  // Ø§ÛŒØ¬Ø§Ø¯ Ø§ÙÚ©Øª Ú©Ù„ÛŒÚ©
  clickEffect = {
    x: x,
    y: y,
    startTime: Date.now()
  };
  
  // Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø±Ù‚Ù‡
  createSparks(x, y, 12);
  
  // Ø´Ø±ÙˆØ¹ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
  swapAnimation.active = true;
  swapAnimation.startTime = Date.now();
  
  // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ø±Ù†Ú¯ Ø§ÙˆÙ„ÛŒÙ‡
  swapAnimation.leftCircle = {
    x: bottomCircles[0].x,
    y: bottomCircles[0].y,
    color: bottomCircles[0].color
  };
  
  swapAnimation.rightCircle = {
    x: bottomCircles[1].x,
    y: bottomCircles[1].y,
    color: bottomCircles[1].color
  };
  
  // ØªØ¹ÛŒÛŒÙ† Ù…Ù‚Ø§ØµØ¯
  swapAnimation.targetLeftX = bottomCircles[1].x;
  swapAnimation.targetRightX = bottomCircles[0].x;
  
  // Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø§ØµÙ„ÛŒ: ØªØºÛŒÛŒØ± Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡
  const tempColor = bottomCircles[0].color;
  bottomCircles[0].color = bottomCircles[1].color;
  bottomCircles[1].color = tempColor;
}

// Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§Ø²ÛŒ
function downloadGame() {
  // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ù„ÛŒÙ†Ú© Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
  const link = document.createElement('a');
  link.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(document.documentElement.outerHTML);
  link.download = 'hania-game.html';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù„Ù…Ø³ÛŒ Ùˆ Ú©Ù„ÛŒÚ©
canvas.addEventListener("click", (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  handleCanvasClick(x, y);
});

// Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù„Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù„Ù…Ø³ÛŒ
canvas.addEventListener("touchstart", (e) => {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  handleCanvasClick(x, y);
}, { passive: false });

// Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
startGameBtn.addEventListener("click", startGame);
gameModesBtn.addEventListener("click", () => {
  gameModesPage.classList.add("active");
});
changeThemeBtn.addEventListener("click", () => {
  updateThemeLocks();
  themeSelection.classList.add("active");
});
customizationBtn.addEventListener("click", () => {
  customizationPage.classList.add("active");
});
downloadBtn.addEventListener("click", downloadGame);
backToMenuBtn.addEventListener("click", () => {
  themeSelection.classList.remove("active");
});
backFromModesBtn.addEventListener("click", () => {
  gameModesPage.classList.remove("active");
});
backFromCustomizationBtn.addEventListener("click", () => {
  customizationPage.classList.remove("active");
});

// Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ…
themeOptions.forEach(option => {
  option.addEventListener("click", () => {
    if (option.classList.contains('locked')) return;
    
    const theme = option.getAttribute("data-theme");
    changeTheme(theme);
  });
});

// Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø§Ù„Øª Ø¨Ø§Ø²ÛŒ
gameModes.forEach(mode => {
  mode.addEventListener("click", () => {
    const modeName = mode.getAttribute("data-mode");
    changeGameMode(modeName);
  });
});

// Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ
customizationOptions.forEach(option => {
  option.addEventListener("click", () => {
    if (option.classList.contains('locked')) return;
    
    const optionName = option.getAttribute("data-option");
    const type = option.getAttribute("data-type");
    changeCustomization(optionName, type);
  });
});

// ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§Ù†ÙˆØ§Ø³ Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù¾Ù†Ø¬Ø±Ù‡
window.addEventListener("resize", () => {
  if (gameActive) {
    resizeCanvas();
  }
});

// Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
resizeCanvas();
updateThemeLocks();

// ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª Ø¨Ø§Ø²ÛŒ Ùˆ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
changeGameMode(currentGameMode);
changeCustomization(currentBallShape, 'ballShape');
changeCustomization(currentEffects, 'effects');

// Ø´Ø±ÙˆØ¹ Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ
frameId = requestAnimationFrame(gameLoop);
</script>
</body>
</html>
