<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <!-- Ø¯Ø± Ø¨Ø®Ø´ head Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a1a2e">
<title>Ù‡Ù†ÛŒØ§</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    user-select: none;
    transition: background 0.5s ease;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ */
  .main-menu {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.7);
    z-index: 100;
    backdrop-filter: blur(5px);
    transition: opacity 0.5s ease;
    padding: 20px;
  }

  .main-menu.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .game-title {
    color: white;
    font-size: clamp(32px, 10vw, 60px);
    margin-bottom: 15px;
    text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    text-align: center;
  }
  
  .high-score {
    color: #ffcc00;
    font-size: clamp(18px, 5vw, 28px);
    margin-bottom: 10px;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    text-align: center;
  }
  
  .player-level {
    color: #00ffcc;
    font-size: clamp(16px, 4vw, 24px);
    margin-bottom: 30px;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    text-align: center;
  }

  .menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 20px;
    width: min(300px, 80%);
  }

  .menu-btn {
    background: linear-gradient(135deg, #ff416c, #ff4b2b);
    border: none;
    color: white;
    padding: 15px 30px;
    border-radius: 30px;
    cursor: pointer;
    font-size: clamp(16px, 5vw, 20px);
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  }

  .menu-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(255, 75, 43, 0.5);
  }

  .theme-btn {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
  }
  
  .download-btn {
    background: linear-gradient(135deg, #00b09b, #96c93d);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ… */
  .theme-selection {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    z-index: 200;
    backdrop-filter: blur(5px);
    padding: 20px;
    overflow-y: auto;
  }

  .theme-selection.active {
    display: flex;
  }

  .theme-title {
    color: white;
    font-size: clamp(24px, 7vw, 36px);
    margin-bottom: 30px;
    text-align: center;
  }

  .theme-options {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 800px;
    width: 100%;
  }

  .theme-option {
    width: min(150px, 40vw);
    height: min(120px, 30vw);
    border-radius: 15px;
    cursor: pointer;
    overflow: hidden;
    position: relative;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }
  
  .theme-option.locked {
    cursor: not-allowed;
    opacity: 0.6;
    filter: grayscale(0.7);
  }

  .theme-option:hover:not(.locked) {
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
  }

  .theme-option.default {
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
  }

  .theme-name {
    position: absolute;
    bottom: 10px;
    left: 0;
    width: 100%;
    text-align: center;
    color: white;
    font-weight: bold;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    font-size: clamp(12px, 3vw, 16px);
  }
  
  .lock-icon {
    position: absolute;
    top: 5px;
    right: 5px;
    color: gold;
    font-size: 20px;
  }
  
  .level-requirement {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
  }

  .back-btn {
    margin-top: 30px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
  }

  .back-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ */
  .game-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  canvas {
    background: linear-gradient(160deg, #222831, #393e46);
    display: none;
    transition: filter 0.5s ease;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .blur-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(5px);
    background: rgba(0, 0, 0, 0.3);
    z-index: 5;
    display: none;
  }

  .score-container {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.5);
    padding: 8px 16px;
    border-radius: 30px;
    color: white;
    font-weight: bold;
    font-size: clamp(14px, 4vw, 20px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: none;
    z-index: 6;
  }
  
  .level-container {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.5);
    padding: 8px 16px;
    border-radius: 30px;
    color: white;
    font-weight: bold;
    font-size: clamp(14px, 4vw, 20px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: none;
    z-index: 6;
  }

  .title {
    position: absolute;
    top: 20px;
    color: white;
    font-size: clamp(18px, 6vw, 28px);
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    text-align: center;
    width: 100%;
    display: none;
    z-index: 6;
  }

  .instructions {
    position: absolute;
    bottom: 20px;
    color: rgba(255, 255, 255, 0.7);
    font-size: clamp(12px, 3vw, 16px);
    text-align: center;
    width: 100%;
    display: none;
    z-index: 6;
    padding: 0 10px;
  }

  .game-over {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    text-align: center;
    font-size: clamp(18px, 6vw, 28px);
    z-index: 10;
    padding: 20px;
  }
  
  .level-up {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    text-align: center;
    font-size: clamp(18px, 6vw, 28px);
    z-index: 15;
    padding: 20px;
    animation: levelUpAnimation 1.5s ease;
  }
  
  @keyframes levelUpAnimation {
    0% { opacity: 0; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }

  .restart-btn, .menu-back-btn {
    background: linear-gradient(135deg, #ff416c, #ff4b2b);
    border: none;
    color: white;
    padding: 10px 20px;
    margin-top: 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: clamp(14px, 4vw, 18px);
    transition: all 0.3s ease;
    margin-right: 10px;
  }

  .menu-back-btn {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
  }

  .restart-btn:hover, .menu-back-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4);
  }

  .button-group {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú© */
  @media (max-width: 480px) and (max-height: 700px) {
    .menu-buttons {
      gap: 15px;
    }
    
    .menu-btn {
      padding: 12px 24px;
    }
    
    .theme-options {
      gap: 10px;
    }
    
    .theme-option {
      width: min(130px, 42vw);
      height: min(100px, 32vw);
    }
    
    .button-group {
      flex-direction: column;
      align-items: center;
    }
    
    .restart-btn, .menu-back-btn {
      margin-right: 0;
      width: 200px;
    }
  }

  /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª landscape Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
  @media (max-height: 500px) {
    .main-menu {
      padding: 10px;
    }
    
    .game-title {
      margin-bottom: 10px;
    }
    
    .high-score {
      margin-bottom: 10px;
    }
    
    .player-level {
      margin-bottom: 20px;
    }
    
    .menu-buttons {
      gap: 15px;
    }
    
    .theme-selection {
      padding: 10px;
    }
    
    .theme-title {
      margin-bottom: 20px;
    }
    
    .theme-options {
      gap: 10px;
    }
  }
</style>
</head>
<body>
<!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
<div class="main-menu" id="mainMenu">
  <h1 class="game-title">Ù‡Ù†ÛŒØ§</h1>
  <div class="high-score" id="highScoreDisplay">Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: 0</div>
  <div class="player-level" id="playerLevelDisplay">Ø³Ø·Ø­: 1</div>
  <div class="menu-buttons">
    <button class="menu-btn" id="startGameBtn">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
    <button class="menu-btn theme-btn" id="changeThemeBtn">ØªØºÛŒÛŒØ± ØªÙ…</button>
    <button class="menu-btn download-btn" id="downloadBtn">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§Ø²ÛŒ</button>
  </div>
</div>

<!-- ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ… -->
<div class="theme-selection" id="themeSelection">
  <h2 class="theme-title">Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ… Ø¨Ø§Ø²ÛŒ</h2>
  <div class="theme-options">
    <div class="theme-option default" data-theme="default">
      <div class="theme-name">ØªÙ… Ù¾ÛŒØ´â€ŒÙØ±Ø¶</div>
    </div>
    <!-- ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ -->
    <div class="theme-option" data-theme="ocean" style="background: linear-gradient(135deg, #a8e6cf, #dcedc1, #ffd3b6);">
      <div class="theme-name">Ø§Ù‚ÛŒØ§Ù†ÙˆØ³ Ø¢Ø±Ø§Ù…</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û²</div>
    </div>
    <div class="theme-option" data-theme="lavender" style="background: linear-gradient(135deg, #e6e6fa, #d8bfd8, #dda0dd);">
      <div class="theme-name">Ø§Ø³Ø·ÙˆØ®ÙˆØ¯ÙˆØ³</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û³</div>
    </div>
    <div class="theme-option" data-theme="sunset" style="background: linear-gradient(135deg, #ffcccb, #ffb6c1, #ffa07a);">
      <div class="theme-name">ØºØ±ÙˆØ¨ Ø¢ÙØªØ§Ø¨</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û´</div>
    </div>
    <div class="theme-option" data-theme="forest" style="background: linear-gradient(135deg, #98fb98, #90ee90, #adff2f);">
      <div class="theme-name">Ø¬Ù†Ú¯Ù„</div>
      <div class="level-requirement">Ø³Ø·Ø­ Ûµ</div>
    </div>
    <div class="theme-option" data-theme="sky" style="background: linear-gradient(135deg, #87ceeb, #b0e0e6, #add8e6);">
      <div class="theme-name">Ø¢Ø³Ù…Ø§Ù†</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û¶</div>
    </div>
    <div class="theme-option" data-theme="desert" style="background: linear-gradient(135deg, #f5deb3, #f4a460, #daa520);">
      <div class="theme-name">Ø¨ÛŒØ§Ø¨Ø§Ù†</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û·</div>
    </div>
    <div class="theme-option" data-theme="berry" style="background: linear-gradient(135deg, #d8bfd8, #ee82ee, #da70d6);">
      <div class="theme-name">ØªÙˆØª</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û¸</div>
    </div>
    <div class="theme-option" data-theme="mint" style="background: linear-gradient(135deg, #98ff98, #afeeee, #e0ffff);">
      <div class="theme-name">Ù†Ø¹Ù†Ø§Ø¹</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û¹</div>
    </div>
    <div class="theme-option" data-theme="rose" style="background: linear-gradient(135deg, #ffe4e1, #ffb6c1, #ff69b4);">
      <div class="theme-name">Ø±Ø²</div>
      <div class="level-requirement">Ø³Ø·Ø­ Û±Û°</div>
    </div>
  </div>
  <button class="back-btn" id="backToMenuBtn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ</button>
</div>

<!-- Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ø²ÛŒ -->
<div class="game-container">
  <div class="title">Ù‡Ù†ÛŒØ§</div>
  <div class="score-container" id="scoreDisplay">Ø§Ù…ØªÛŒØ§Ø²: 0</div>
  <div class="level-container" id="levelDisplay">Ø³Ø·Ø­: 1</div>
  <canvas id="game"></canvas>
  <div class="blur-overlay" id="blurOverlay"></div>
  <div class="instructions">Ø¨Ø±Ø§ÛŒ ØªØ¹ÙˆÛŒØ¶ Ø±Ù†Ú¯ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>

  <!-- ØµÙØ­Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ -->
  <div class="game-over" id="gameOver">
    <div>Ø´Ù…Ø§ Ø¨Ø§Ø®ØªÛŒ!</div>
    <div>Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ: <span id="finalScore">0</span></div>
    <div class="button-group">
      <button class="restart-btn" onclick="restartGame()">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
      <button class="menu-back-btn" onclick="backToMainMenu()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ</button>
    </div>
  </div>
  
  <!-- ØµÙØ­Ù‡ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­ -->
  <div class="level-up" id="levelUp">
    <div>ØªØ¨Ø±ÛŒÚ©!</div>
    <div>Ø´Ù…Ø§ Ø¨Ù‡ Ø³Ø·Ø­ <span id="newLevel">2</span> Ø±Ø³ÛŒØ¯ÛŒØ¯!</div>
    <div class="button-group">
      <button class="restart-btn" onclick="closeLevelUp()">Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ø²ÛŒ</button>
    </div>
  </div>
</div>

<script>
// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreDisplay = document.getElementById("scoreDisplay");
const levelDisplay = document.getElementById("levelDisplay");
const gameOverScreen = document.getElementById("gameOver");
const finalScoreDisplay = document.getElementById("finalScore");
const mainMenu = document.getElementById("mainMenu");
const themeSelection = document.getElementById("themeSelection");
const startGameBtn = document.getElementById("startGameBtn");
const changeThemeBtn = document.getElementById("changeThemeBtn");
const downloadBtn = document.getElementById("downloadBtn");
const backToMenuBtn = document.getElementById("backToMenuBtn");
const themeOptions = document.querySelectorAll(".theme-option");
const blurOverlay = document.getElementById("blurOverlay");
const highScoreDisplay = document.getElementById("highScoreDisplay");
const playerLevelDisplay = document.getElementById("playerLevelDisplay");
const levelUpScreen = document.getElementById("levelUp");
const newLevelDisplay = document.getElementById("newLevel");

let w, h;

// ØªØ¹Ø±ÛŒÙ ØªÙ…â€ŒÙ‡Ø§ Ø¨Ø§ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÙˆØ¹
const themes = {
  'default': {
    background: ['#1a1a2e', '#16213e', '#0f3460'],
    ballColors: ['#393e46', 'white'],
    levelRequired: 1
  },
  'ocean': {
    background: ['#a8e6cf', '#dcedc1', '#ffd3b6'],
    ballColors: ['#45b7d1', '#96ceb4'],
    levelRequired: 2
  },
  'lavender': {
    background: ['#e6e6fa', '#d8bfd8', '#dda0dd'],
    ballColors: ['#9370db', '#ba55d3'],
    levelRequired: 3
  },
  'sunset': {
    background: ['#ffcccb', '#ffb6c1', '#ffa07a'],
    ballColors: ['#ff6347', '#ff4500'],
    levelRequired: 4
  },
  'forest': {
    background: ['#98fb98', '#90ee90', '#adff2f'],
    ballColors: ['#228b22', '#006400'],
    levelRequired: 5
  },
  'sky': {
    background: ['#87ceeb', '#b0e0e6', '#add8e6'],
    ballColors: ['#1e90ff', '#0000ff'],
    levelRequired: 6
  },
  'desert': {
    background: ['#f5deb3', '#f4a460', '#daa520'],
    ballColors: ['#cd853f', '#8b4513'],
    levelRequired: 7
  },
  'berry': {
    background: ['#d8bfd8', '#ee82ee', '#da70d6'],
    ballColors: ['#c71585', '#8b008b'],
    levelRequired: 8
  },
  'mint': {
    background: ['#98ff98', '#afeeee', '#e0ffff'],
    ballColors: ['#20b2aa', '#008080'],
    levelRequired: 9
  },
  'rose': {
    background: ['#ffe4e1', '#ffb6c1', '#ff69b4'],
    ballColors: ['#ff1493', '#c71585'],
    levelRequired: 10
  }
};

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² localStorage
let currentTheme = localStorage.getItem('hania-theme') || 'default';
let highScore = parseInt(localStorage.getItem('hania-highscore')) || 0;
let playerLevel = parseInt(localStorage.getItem('hania-level')) || 1;

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ø³Ø·Ø­ Ø¯Ø± ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
highScoreDisplay.textContent = `Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: ${highScore}`;
playerLevelDisplay.textContent = `Ø³Ø·Ø­: ${playerLevel}`;

let bottomCircles = [];
let balls = [];
let score = 0;
let spawnInterval = 2000;
let speed = 5;
let lastTime = 0;
let clickEffect = null;
let gameActive = false;
let nextSpawnTime = 0;
let frameId = null;

// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
let swapAnimation = {
  active: false,
  startTime: 0,
  duration: 400, // Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ù‡ Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡
  leftCircle: { x: 0, y: 0, color: '' },
  rightCircle: { x: 0, y: 0, color: '' },
  targetLeftX: 0,
  targetRightX: 0
};

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§Ù†ÙˆØ§Ø³
function resizeCanvas() {
  w = window.innerWidth;
  h = window.innerHeight;
  
  canvas.width = w;
  canvas.height = h;
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†
  bottomCircles = [
    { x: w / 4, y: h - 50, color: themes[currentTheme].ballColors[0] },
    { x: (3 * w) / 4, y: h - 50, color: themes[currentTheme].ballColors[1] }
  ];
}

// Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
function startGame() {
  // ØªÙ†Ø¸ÛŒÙ… Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§Ù†ÙˆØ§Ø³
  resizeCanvas();
  
  // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
  mainMenu.classList.add("hidden");
  
  // Ù†Ù…Ø§ÛŒØ´ Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ø²ÛŒ
  canvas.style.display = "block";
  scoreDisplay.style.display = "block";
  levelDisplay.style.display = "block";
  document.querySelector(".title").style.display = "block";
  document.querySelector(".instructions").style.display = "block";
  
  // ØªÙ†Ø¸ÛŒÙ… ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ
  gameActive = true;
  balls = [];
  score = 0;
  scoreDisplay.textContent = "Ø§Ù…ØªÛŒØ§Ø²: " + score;
  levelDisplay.textContent = "Ø³Ø·Ø­: " + playerLevel;
  gameOverScreen.style.display = "none";
  blurOverlay.style.display = "none";
  levelUpScreen.style.display = "none";
  lastTime = 0;
  nextSpawnTime = 0;
  
  // Ø´Ø±ÙˆØ¹ Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ
  if (frameId) {
    cancelAnimationFrame(frameId);
  }
  frameId = requestAnimationFrame(gameLoop);
}

// Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
function backToMainMenu() {
  // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ø²ÛŒ
  canvas.style.display = "none";
  scoreDisplay.style.display = "none";
  levelDisplay.style.display = "none";
  document.querySelector(".title").style.display = "none";
  document.querySelector(".instructions").style.display = "none";
  gameOverScreen.style.display = "none";
  blurOverlay.style.display = "none";
  levelUpScreen.style.display = "none";
  
  // Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
  mainMenu.classList.remove("hidden");
  
  // ØªÙˆÙ‚Ù Ø¨Ø§Ø²ÛŒ
  gameActive = false;
  if (frameId) {
    cancelAnimationFrame(frameId);
    frameId = null;
  }
}

// ØªØºÛŒÛŒØ± ØªÙ…
function changeTheme(themeName) {
  currentTheme = themeName;
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ù†Ú¯ ØªÙˆÙ¾â€ŒÙ‡Ø§
  bottomCircles[0].color = themes[themeName].ballColors[0];
  bottomCircles[1].color = themes[themeName].ballColors[1];
  
  // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
  localStorage.setItem('hania-theme', themeName);
  
  // Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ…
  themeSelection.classList.remove("active");
}

// Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø·Ø­ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù‚ÙÙ„â€ŒÚ¯Ø°Ø§Ø±ÛŒ ØªÙ…â€ŒÙ‡Ø§
function updateThemeLocks() {
  const themeOptions = document.querySelectorAll('.theme-option');
  
  themeOptions.forEach(option => {
    const themeName = option.getAttribute('data-theme');
    const levelRequired = themes[themeName].levelRequired;
    
    if (playerLevel >= levelRequired) {
      option.classList.remove('locked');
      const lockIcon = option.querySelector('.lock-icon');
      if (lockIcon) lockIcon.remove();
    } else {
      option.classList.add('locked');
      if (!option.querySelector('.lock-icon')) {
        const lockIcon = document.createElement('div');
        lockIcon.className = 'lock-icon';
        lockIcon.innerHTML = 'ğŸ”’';
        option.appendChild(lockIcon);
      }
    }
  });
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ø§ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ Ø³Ù…Øªâ€ŒÙ‡Ø§
function spawnBalls() {
  const ballColors = themes[currentTheme].ballColors;
  if (Math.random() < 0.5) {
    balls.push({ x: w / 4, y: 0, color: ballColors[0] });
    balls.push({ x: (3 * w) / 4, y: 0, color: ballColors[1] });
  } else {
    balls.push({ x: w / 4, y: 0, color: ballColors[1] });
    balls.push({ x: (3 * w) / 4, y: 0, color: ballColors[0] });
  }
}

// Ø±Ø³Ù… Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø§ Ø¸Ø§Ù‡Ø± Ø²ÛŒØ¨Ø§
function drawBottomCircle(x, y, color, r = 30) {
  // ØªÙ†Ø¸ÛŒÙ… Ø´Ø¹Ø§Ø¹ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ­Ù‡
  const radius = Math.max(20, r * (w / 400));
  
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  
  // Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†
  let gradient;
  const isLightColor = color === 'white' || color === '#ffd700' || color === '#00ff7f' || color === '#00bfff' || color === '#00ced1' || color === '#00ffff';
  
  if (isLightColor) {
    gradient = ctx.createRadialGradient(x-8, y-8, 5, x, y, radius);
    gradient.addColorStop(0, "#ffffff");
    gradient.addColorStop(0.7, "#e0e0e0");
    gradient.addColorStop(1, "#c0c0c0");
  } else {
    gradient = ctx.createRadialGradient(x-8, y-8, 5, x, y, radius);
    gradient.addColorStop(0, lightenColor(color, 40));
    gradient.addColorStop(0.7, color);
    gradient.addColorStop(1, darkenColor(color, 20));
  }
  
  ctx.fillStyle = gradient;
  ctx.shadowColor = isLightColor ? "rgba(255,255,255,0.5)" : "rgba(100,100,100,0.5)";
  ctx.shadowBlur = 15;
  ctx.shadowOffsetX = 2;
  ctx.shadowOffsetY = 2;
  ctx.fill();
  
  // Ø­Ø§Ø´ÛŒÙ‡ Ø¨Ø±Ø§Ù‚
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.strokeStyle = isLightColor ? "rgba(255,255,255,0.8)" : "rgba(150,150,150,0.8)";
  ctx.lineWidth = 2;
  ctx.stroke();
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø±Ù†Ú¯
function lightenColor(color, percent) {
  if (color.startsWith('#')) {
    const num = parseInt(color.slice(1), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    return `#${(0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1)}`;
  }
  return color;
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªÛŒØ±Ù‡ Ú©Ø±Ø¯Ù† Ø±Ù†Ú¯
function darkenColor(color, percent) {
  if (color.startsWith('#')) {
    const num = parseInt(color.slice(1), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) - amt;
    const G = (num >> 8 & 0x00FF) - amt;
    const B = (num & 0x0000FF) - amt;
    return `#${(0x1000000 + (R > 0 ? R : 0) * 0x10000 +
            (G > 0 ? G : 0) * 0x100 +
            (B > 0 ? B : 0)).toString(16).slice(1)}`;
  }
  return color;
}

// Ø±Ø³Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø³Ù‚ÙˆØ· Ø¨Ø§ Ø¸Ø§Ù‡Ø± Ø²ÛŒØ¨Ø§
function drawBall(x, y, color, r = 20) {
  // ØªÙ†Ø¸ÛŒÙ… Ø´Ø¹Ø§Ø¹ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ­Ù‡
  const radius = Math.max(15, r * (w / 400));
  
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  
  // Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
  let gradient;
  const isLightColor = color === 'white' || color === '#ffd700' || color === '#00ff7f' || color === '#00bfff' || color === '#00ced1' || color === '#00ffff';
  
  if (isLightColor) {
    gradient = ctx.createRadialGradient(x-6, y-6, 3, x, y, radius);
    gradient.addColorStop(0, "#ffffff");
    gradient.addColorStop(0.6, "#d0d0d0");
    gradient.addColorStop(1, "#a0a0a0");
  } else {
    gradient = ctx.createRadialGradient(x-6, y-6, 3, x, y, radius);
    gradient.addColorStop(0, lightenColor(color, 30));
    gradient.addColorStop(0.6, color);
    gradient.addColorStop(1, darkenColor(color, 20));
  }
  
  ctx.fillStyle = gradient;
  ctx.shadowColor = isLightColor ? "rgba(255,255,255,0.5)" : "rgba(0,0,0,0.7)";
  ctx.shadowBlur = 10;
  ctx.fill();
  
  // Ø¯Ø±Ø®Ø´Ø´ Ø¯Ø§Ø®Ù„ÛŒ
  ctx.beginPath();
  ctx.arc(x, y, radius-5, 0, Math.PI * 2);
  ctx.strokeStyle = isLightColor ? "rgba(255,255,255,0.4)" : "rgba(100,100,100,0.4)";
  ctx.lineWidth = 1;
  ctx.stroke();
  
  // Ù†Ù‚Ø·Ù‡ Ø¨Ø±Ø§Ù‚
  ctx.beginPath();
  ctx.arc(x-5, y-5, 4, 0, Math.PI * 2);
  ctx.fillStyle = isLightColor ? "rgba(255,255,255,0.9)" : "rgba(180,180,180,0.7)";
  ctx.fill();
}

// Ø±Ø³Ù… Ø§ÙÚ©Øª Ú©Ù„ÛŒÚ©
function drawClickEffect() {
  if (clickEffect) {
    const elapsed = Date.now() - clickEffect.startTime;
    const progress = Math.min(elapsed / 300, 1); // 300ms duration
    const alpha = 1 - progress;
    const radius = 30 + progress * 40;
    
    ctx.beginPath();
    ctx.arc(clickEffect.x, clickEffect.y, radius, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(255, 215, 0, ${alpha})`;
    ctx.lineWidth = 3;
    ctx.stroke();
    
    if (progress >= 1) {
      clickEffect = null;
    }
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
function drawSwapAnimation() {
  if (!swapAnimation.active) return;
  
  const elapsed = Date.now() - swapAnimation.startTime;
  const progress = Math.min(elapsed / swapAnimation.duration, 1);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ easeOutCubic Ø¨Ø±Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†Ø±Ù…
  const easedProgress = 1 - Math.pow(1 - progress, 3);
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
  const leftX = swapAnimation.leftCircle.x + (swapAnimation.targetLeftX - swapAnimation.leftCircle.x) * easedProgress;
  const rightX = swapAnimation.rightCircle.x + (swapAnimation.targetRightX - swapAnimation.rightCircle.x) * easedProgress;
  
  // Ø±Ø³Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ
  drawBottomCircle(leftX, swapAnimation.leftCircle.y, swapAnimation.leftCircle.color);
  drawBottomCircle(rightX, swapAnimation.rightCircle.y, swapAnimation.rightCircle.color);
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ù…ØªØµÙ„ Ú©Ù†Ù†Ø¯Ù‡
  ctx.beginPath();
  ctx.moveTo(leftX, swapAnimation.leftCircle.y);
  ctx.lineTo(rightX, swapAnimation.rightCircle.y);
  ctx.strokeStyle = `rgba(255, 255, 255, ${0.5 * (1 - progress)})`;
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // Ø§Ú¯Ø± Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
  if (progress >= 1) {
    swapAnimation.active = false;
  }
}

// Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Object Pooling Ø¨Ø±Ø§ÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
const ballPool = {
  pool: [],
  get: function(x, y, color) {
    if (this.pool.length > 0) {
      const ball = this.pool.pop();
      ball.x = x;
      ball.y = y;
      ball.color = color;
      return ball;
    }
    return { x, y, color };
  },
  release: function(ball) {
    this.pool.push(ball);
  }
};

// Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Spatial Partitioning Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø¨Ø±Ø®ÙˆØ±Ø¯
const spatialGrid = {
  cellSize: 50,
  grid: {},
  
  clear: function() {
    this.grid = {};
  },
  
  addBall: function(ball) {
    const cellX = Math.floor(ball.x / this.cellSize);
    const cellY = Math.floor(ball.y / this.cellSize);
    const key = `${cellX},${cellY}`;
    
    if (!this.grid[key]) {
      this.grid[key] = [];
    }
    this.grid[key].push(ball);
  },
  
  getNearbyBalls: function(x, y) {
    const cellX = Math.floor(x / this.cellSize);
    const cellY = Math.floor(y / this.cellSize);
    const result = [];
    
    for (let dx = -1; dx <= 1; dx++) {
      for (let dy = -1; dy <= 1; dy++) {
        const key = `${cellX + dx},${cellY + dy}`;
        if (this.grid[key]) {
          result.push(...this.grid[key]);
        }
      }
    }
    
    return result;
  }
};

// Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­
function checkLevelUp() {
  const newLevel = Math.min(10, Math.floor(score / 10) + 1);
  
  if (newLevel > playerLevel) {
    playerLevel = newLevel;
    localStorage.setItem('hania-level', playerLevel);
    playerLevelDisplay.textContent = `Ø³Ø·Ø­: ${playerLevel}`;
    levelDisplay.textContent = `Ø³Ø·Ø­: ${playerLevel}`;
    
    // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­
    newLevelDisplay.textContent = playerLevel;
    levelUpScreen.style.display = "flex";
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÙÙ„ ØªÙ…â€ŒÙ‡Ø§
    updateThemeLocks();
    
    return true;
  }
  return false;
}

// Ø¨Ø³ØªÙ† ØµÙØ­Ù‡ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­
function closeLevelUp() {
  levelUpScreen.style.display = "none";
}

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª ØªÙˆÙ¾â€ŒÙ‡Ø§
function update(deltaTime) {
  if (!gameActive) return;
  
  ctx.clearRect(0, 0, w, h);
  
  // Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø²ÛŒØ¨Ø§
  const gradient = ctx.createLinearGradient(0, 0, 0, h);
  const themeColors = themes[currentTheme].background;
  gradient.addColorStop(0, themeColors[0]);
  gradient.addColorStop(0.5, themeColors[1]);
  gradient.addColorStop(1, themeColors[2]);
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, w, h);
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø±Ø§Ù‡Ù†Ù…Ø§
  ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(w/2, 0);
  ctx.lineTo(w/2, h);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø´Ø¨Ú©Ù‡ ÙØ¶Ø§ÛŒÛŒ
  spatialGrid.clear();
  
  // Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª ØªÙˆÙ¾â€ŒÙ‡Ø§ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ ÙØ¶Ø§ÛŒÛŒ
  for (let i = 0; i < balls.length; i++) {
    const b = balls[i];
    b.y += speed * (deltaTime / 16);
    spatialGrid.addBall(b);
  }
  
  // Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ: ØªØ´Ø®ÛŒØµ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø´Ø¨Ú©Ù‡ ÙØ¶Ø§ÛŒÛŒ
  for (let i = balls.length - 1; i >= 0; i--) {
    const b = balls[i];
    
    // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†
    if (b.y > h - 80) {
      // Ø§ÛŒÙ† Ù‚Ø³Ù…Øª Ú©Ù„ÛŒØ¯ÛŒ Ø§Ø³Øª - Ø¨Ø§ÛŒØ¯ Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ ØªÙˆÙ¾ Ø±Ø§ Ø¨Ø§ Ø±Ù†Ú¯ ØªÙˆÙ¾â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ† Ù…Ù‚Ø§ÛŒØ³Ù‡ Ú©Ù†ÛŒÙ…
      // Ù†Ù‡ Ø¨Ø§ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø§Ø¨Øª Ø¢Ù†â€ŒÙ‡Ø§
      let target;
      if (b.x < w / 2) {
        // ØªÙˆÙ¾ Ø¯Ø± Ø³Ù…Øª Ú†Ù¾ Ø§Ø³Øª
        target = bottomCircles[0];
      } else {
        // ØªÙˆÙ¾ Ø¯Ø± Ø³Ù…Øª Ø±Ø§Ø³Øª Ø§Ø³Øª
        target = bottomCircles[1];
      }
      
      if (b.color === target.color) {
        score++;
        scoreDisplay.textContent = "Ø§Ù…ØªÛŒØ§Ø²: " + score;
        ballPool.release(balls[i]);
        balls.splice(i, 1); // Ø­Ø°Ù ØªÙˆÙ¾ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±Ø®ÙˆØ±Ø¯ ØµØ­ÛŒØ­
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø·Ø­
        checkLevelUp();
      } else {
        // ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
        if (gameActive) {
          gameOver();
        }
        // ØªÙˆÙ¾ Ø­Ø°Ù Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¯Ø± Ø¬Ø§ÛŒ Ø®ÙˆØ¯ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
      }
    }
  }
  
  // Ø±Ø³Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§
  for (let i = 0; i < balls.length; i++) {
    const b = balls[i];
    drawBall(b.x, b.y, b.color, 20);
  }

  // Ø±Ø³Ù… Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ† (Ø§Ú¯Ø± Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª)
  if (!swapAnimation.active) {
    for (let c of bottomCircles) {
      drawBottomCircle(c.x, c.y, c.color);
    }
  }
  
  // Ø±Ø³Ù… Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§ (Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯)
  drawSwapAnimation();
  
  // Ø±Ø³Ù… Ø§ÙÚ©Øª Ú©Ù„ÛŒÚ©
  drawClickEffect();
}

// Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ (Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡)
function gameLoop(timestamp) {
  if (!lastTime) lastTime = timestamp;
  const deltaTime = timestamp - lastTime;
  lastTime = timestamp;

  // Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ¾â€ŒÙ‡Ø§
  if (gameActive && timestamp > nextSpawnTime) {
    spawnBalls();
    nextSpawnTime = timestamp + spawnInterval;
    
    // Ø§ÙØ²Ø§ÛŒØ´ Ø³Ø±Ø¹Øª Ùˆ Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²
    if (score > 0 && score % 5 === 0) {
      speed = Math.min(10, 5 + Math.floor(score / 5));
      spawnInterval = Math.max(800, 2000 - Math.floor(score / 5) * 100);
    }
  }

  update(deltaTime);
  frameId = requestAnimationFrame(gameLoop);
}

// Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ
function gameOver() {
  gameActive = false;
  finalScoreDisplay.textContent = score;
  gameOverScreen.style.display = "flex";
  blurOverlay.style.display = "block";
  
  // Ø°Ø®ÛŒØ±Ù‡ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²
  if (score > highScore) {
    highScore = score;
    localStorage.setItem('hania-highscore', highScore);
    highScoreDisplay.textContent = `Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: ${highScore}`;
  }
}

// Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§Ø²ÛŒ
function restartGame() {
  // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨Ù‡ Ø§Ø³ØªØ®Ø±
  for (let ball of balls) {
    ballPool.release(ball);
  }
  balls = [];
  
  score = 0;
  speed = 5;
  spawnInterval = 2000;
  scoreDisplay.textContent = "Ø§Ù…ØªÛŒØ§Ø²: " + score;
  gameActive = true;
  gameOverScreen.style.display = "none";
  blurOverlay.style.display = "none";
  levelUpScreen.style.display = "none";
  lastTime = 0;
  nextSpawnTime = 0;
  
  // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ
  if (frameId) {
    cancelAnimationFrame(frameId);
  }
  frameId = requestAnimationFrame(gameLoop);
}

// ØªØ¹ÙˆÛŒØ¶ Ø±Ù†Ú¯ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ú©Ù„ÛŒÚ© (Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†)
function handleCanvasClick(x, y) {
  if (!gameActive || swapAnimation.active) return;
  
  // Ø§ÛŒØ¬Ø§Ø¯ Ø§ÙÚ©Øª Ú©Ù„ÛŒÚ©
  clickEffect = {
    x: x,
    y: y,
    startTime: Date.now()
  };
  
  // Ø´Ø±ÙˆØ¹ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ØªÙˆÙ¾â€ŒÙ‡Ø§
  swapAnimation.active = true;
  swapAnimation.startTime = Date.now();
  
  // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ø±Ù†Ú¯ Ø§ÙˆÙ„ÛŒÙ‡
  swapAnimation.leftCircle = {
    x: bottomCircles[0].x,
    y: bottomCircles[0].y,
    color: bottomCircles[0].color
  };
  
  swapAnimation.rightCircle = {
    x: bottomCircles[1].x,
    y: bottomCircles[1].y,
    color: bottomCircles[1].color
  };
  
  // ØªØ¹ÛŒÛŒÙ† Ù…Ù‚Ø§ØµØ¯
  swapAnimation.targetLeftX = bottomCircles[1].x;
  swapAnimation.targetRightX = bottomCircles[0].x;
  
  // Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø§ØµÙ„ÛŒ: ØªØºÛŒÛŒØ± Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡
  const tempColor = bottomCircles[0].color;
  bottomCircles[0].color = bottomCircles[1].color;
  bottomCircles[1].color = tempColor;
}

// Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§Ø²ÛŒ
function downloadGame() {
  // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ù„ÛŒÙ†Ú© Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
  const link = document.createElement('a');
  link.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(document.documentElement.outerHTML);
  link.download = 'hania-game.html';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù„Ù…Ø³ÛŒ Ùˆ Ú©Ù„ÛŒÚ©
canvas.addEventListener("click", (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  handleCanvasClick(x, y);
});

// Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù„Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù„Ù…Ø³ÛŒ
canvas.addEventListener("touchstart", (e) => {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches[0];
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  handleCanvasClick(x, y);
}, { passive: false });

// Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
startGameBtn.addEventListener("click", startGame);
changeThemeBtn.addEventListener("click", () => {
  updateThemeLocks();
  themeSelection.classList.add("active");
});
downloadBtn.addEventListener("click", downloadGame);
backToMenuBtn.addEventListener("click", () => {
  themeSelection.classList.remove("active");
});

// Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ…
themeOptions.forEach(option => {
  option.addEventListener("click", () => {
    if (option.classList.contains('locked')) return;
    
    const theme = option.getAttribute("data-theme");
    changeTheme(theme);
  });
});

// ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§Ù†ÙˆØ§Ø³ Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù¾Ù†Ø¬Ø±Ù‡
window.addEventListener("resize", () => {
  if (gameActive) {
    resizeCanvas();
  }
});

// Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
resizeCanvas();
updateThemeLocks();

// Ø´Ø±ÙˆØ¹ Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ
frameId = requestAnimationFrame(gameLoop);
</script>
</body>
</html>
